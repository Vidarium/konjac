---
title: "Konjac Glucomannan Reduces Body Fat, Inflammation, Cholesterol Levels, and Cardiovascular Risk in Adults with Excess Weight: A Triple-Blind, Placebo-Controlled Randomized Clinical Trial"
author: 'Juan S. Escobar et al. 2025'
output: html_notebook
---

# Inital commands
```{r Initial commands}
# Clean the work space
#rm(list = ls())

# Seed for random generation
set.seed(5600)

# Upload libraries
library(readxl)
library(dplyr)
library(table1)
library(reshape2)
library(nlme)
library(emmeans)
library(MASS)
library(stringr)
library(ggplot2)
library(rstatix)
library(ggpubr)
library(cowplot)
library(phyloseq)
library(decontam)
library(BiodiversityR)
library(tidyverse)
library(microViz)
library(ALDEx2)

```

# Required functions
```{r Required functions}
# General function to copy-paste R tables into Excel
write.excel <- function(x, row.names=FALSE, col.names=TRUE, ...) {
  write.table(x, file = paste0("clipboard-", object.size(x)), sep="\t", row.names=row.names, col.names=col.names,...)
}

# P-value column for Table 1
pvalue <- function(x, ...) {
    # Construct vectors of data y, and groups (strata) g
    y <- unlist(x)
    g <- factor(rep(1:length(x), times=sapply(x, length)))
    if (is.numeric(y)) {
        # For numeric variables, perform a standard 2-sample t-test
        p <- t.test(y ~ g, paired = TRUE)$p.value
    } else {
        # For categorical variables, perform a chi-squared test of independence
        p <- chisq.test(table(y, g))$p.value
    }
    # Format the p-value, using an HTML entity for the less-than sign.
    # The initial empty string places the output on the line below the variable label.
    c("", sub("<", "&lt;", format.pval(p, digits=3, eps=0.001)))
}

# Mean, SD, ad 95% confidence intervals for Table 1
my.render.cont <- function(x) {
  with(stats.apply.rounding(stats.default(x), digits=2), c("",
  "N"=stats.default(x)$N,
  "Mean (SD)"=sprintf("%s (%s)", round(stats.default(x)$MEAN, 2), round(stats.default(x)$SD, 2)),
  "95% CI"=sprintf("%s &plusmn; %s", round(stats.default(x)$MEAN-qt(0.975,stats.default(x)$N-1)*stats.default(x)$SD/sqrt(stats.default(x)$N),2), round(stats.default(x)$MEAN+qt(0.975,stats.default(x)$N-1)*stats.default(x)$SD/sqrt(stats.default(x)$N),2))))
}

```

# Prepare data
```{r Prepare data}
# Load data ----
setwd(dir="C:/Documentos Disco D/Vidarium/GitHub/konjac") #change as appropriate

konjac <- read_excel("konjac_db.xlsx")

# Calculate BMI
konjac$BMI_t1 <- konjac$weight_t1/konjac$height^2
konjac$BMI_t2 <- konjac$weight_t2/konjac$height^2
konjac$BMI_t3 <- konjac$weight_t3/konjac$height^2

# Calculate atherogenic index
konjac$ateroindex_t1 <- konjac$totChol_t1/konjac$HDL_t1
konjac$ateroindex_t3 <- konjac$totChol_t3/konjac$HDL_t3

# Calculate HOMA-IR
konjac$homa_t1 <- konjac$insulin_t1*konjac$glycaemia_t1/405
konjac$homa_t3 <- konjac$insulin_t3*konjac$glycaemia_t3/405

# Calculate leptin/adiponectin
konjac$Leptin_Adiponectin_t1 <- konjac$Leptin_t1/konjac$Adiponectin_t1
konjac$Leptin_Adiponectin_t3 <- konjac$Leptin_t3/konjac$Adiponectin_t3

# Add supplemented nutrients to the values obtained with 24-h recalls
konjac$KCAL_t1 <- ifelse(konjac$treatment == "FI236", 
                         konjac$KCAL_t1+9, konjac$KCAL_t1+7)
konjac$KCAL_t2 <- ifelse(konjac$treatment == "FI236", 
                         konjac$KCAL_t2+9, konjac$KCAL_t2+7)
konjac$KCAL_t3 <- ifelse(konjac$treatment == "FI236", 
                         konjac$KCAL_t3+9, konjac$KCAL_t3+7)

konjac$CARB_t1 <- ifelse(konjac$treatment == "FI236", 
                         konjac$CARB_t1+2.10, konjac$CARB_t1+2.31)
konjac$CARB_t2 <- ifelse(konjac$treatment == "FI236", 
                         konjac$CARB_t2+2.10, konjac$CARB_t2+2.31)
konjac$CARB_t3 <- ifelse(konjac$treatment == "FI236", 
                         konjac$CARB_t3+2.10, konjac$CARB_t3+2.31)

konjac$PROT_t1 <- ifelse(konjac$treatment == "FI236", 
                         konjac$PROT_t1+0.11, konjac$PROT_t1+0.06)
konjac$PROT_t2 <- ifelse(konjac$treatment == "FI236", 
                         konjac$PROT_t2+0.11, konjac$PROT_t2+0.06)
konjac$PROT_t3 <- ifelse(konjac$treatment == "FI236", 
                         konjac$PROT_t3+0.11, konjac$PROT_t3+0.06)

konjac$TFAT_t1 <- ifelse(konjac$treatment == "FI236", 
                         konjac$TFAT_t1+0.12, konjac$TFAT_t1+0.06)
konjac$TFAT_t2 <- ifelse(konjac$treatment == "FI236", 
                         konjac$TFAT_t2+0.12, konjac$TFAT_t2+0.06)
konjac$TFAT_t3 <- ifelse(konjac$treatment == "FI236", 
                         konjac$TFAT_t3+0.12, konjac$TFAT_t3+0.06)

konjac$FIBE_t1 <- ifelse(konjac$treatment == "FI236", 
                         konjac$FIBE_t1+0.31, konjac$FIBE_t1+1.30)
konjac$FIBE_t2 <- ifelse(konjac$treatment == "FI236", 
                         konjac$FIBE_t2+0.31, konjac$FIBE_t2+1.30)
konjac$FIBE_t3 <- ifelse(konjac$treatment == "FI236", 
                         konjac$FIBE_t3+0.31, konjac$FIBE_t3+1.30)

# Calculate normalized nutrient intake
konjac$KCALperkg_t1 <- konjac$KCAL_t1/konjac$weight_t1
konjac$KCALperkg_t2 <- konjac$KCAL_t2/konjac$weight_t2
konjac$KCALperkg_t3 <- konjac$KCAL_t3/konjac$weight_t3

konjac$CARBperkg_t1 <- konjac$CARB_t1/konjac$weight_t1
konjac$CARBperkg_t2 <- konjac$CARB_t2/konjac$weight_t2
konjac$CARBperkg_t3 <- konjac$CARB_t3/konjac$weight_t3

konjac$PROTperkg_t1 <- konjac$PROT_t1/konjac$weight_t1
konjac$PROTperkg_t2 <- konjac$PROT_t2/konjac$weight_t2
konjac$PROTperkg_t3 <- konjac$PROT_t3/konjac$weight_t3

konjac$TFATperkg_t1 <- konjac$TFAT_t1/konjac$weight_t1
konjac$TFATperkg_t2 <- konjac$TFAT_t2/konjac$weight_t2
konjac$TFATperkg_t3 <- konjac$TFAT_t3/konjac$weight_t3

konjac$FIBEperkg_t1 <- konjac$FIBE_t1/konjac$weight_t1
konjac$FIBEperkg_t2 <- konjac$FIBE_t2/konjac$weight_t2
konjac$FIBEperkg_t3 <- konjac$FIBE_t3/konjac$weight_t3

konjac$SUGRperkg_t1 <- konjac$SUGR_t1/konjac$weight_t1
konjac$SUGRperkg_t2 <- konjac$SUGR_t2/konjac$weight_t2
konjac$SUGRperkg_t3 <- konjac$SUGR_t3/konjac$weight_t3

# Calculate % of macronutrient intake
konjac$CARBperc_t1 <- konjac$CARB_t1*4/konjac$KCAL_t1*100
konjac$CARBperc_t2 <- konjac$CARB_t2*4/konjac$KCAL_t2*100
konjac$CARBperc_t3 <- konjac$CARB_t3*4/konjac$KCAL_t3*100

konjac$PROTperc_t1 <- konjac$PROT_t1*4/konjac$KCAL_t1*100
konjac$PROTperc_t2 <- konjac$PROT_t2*4/konjac$KCAL_t2*100
konjac$PROTperc_t3 <- konjac$PROT_t3*4/konjac$KCAL_t3*100

konjac$TFATperc_t1 <- konjac$TFAT_t1*9/konjac$KCAL_t1*100
konjac$TFATperc_t2 <- konjac$TFAT_t2*9/konjac$KCAL_t2*100
konjac$TFATperc_t3 <- konjac$TFAT_t3*9/konjac$KCAL_t3*100

# Calculate intervention adherence
konjac$adh_sachets <- konjac$Sachets_empty/konjac$Sachets_delivered

# Calculate physical activity (daily steps)
konjac$daily_steps <- konjac$Total_steps/90

# Calculate Framingham Risk Score for Coronary Heart Disease
konjac$framingham_t1 <- ifelse(konjac$sex == "Male", 52.00961*log(konjac$age) + 20.014077*log(konjac$totChol_t1) + -0.905964*log(konjac$HDL_t1) + 1.305784*log(konjac$systolic_t1) + -4.605038*log(konjac$age)*log(konjac$totChol_t1) + -2.93323*log(konjac$age)*log(konjac$age) - 172.300168 + ifelse(konjac$medication_hypertension_t1 =="Yes", 0.241549, 0), 31.764001*log(konjac$age) + 22.465206*log(konjac$totChol_t1) + -1.187731*log(konjac$HDL_t1) + 2.552905*log(konjac$systolic_t1) + -5.060998*log(konjac$age)*log(konjac$totChol_t1) +  - 146.5933061 + ifelse(konjac$medication_hypertension_t1 =="Yes", 0.420251, 0))

konjac$framingham_t3 <- ifelse(konjac$sex == "Male", 52.00961*log(konjac$age) + 20.014077*log(konjac$totChol_t3) + -0.905964*log(konjac$HDL_t3) + 1.305784*log(konjac$systolic_t3) + -4.605038*log(konjac$age)*log(konjac$totChol_t3) + -2.93323*log(konjac$age)*log(konjac$age) - 172.300168 + ifelse(konjac$medication_hypertension_t1 =="Yes", 0.241549, 0), 31.764001*log(konjac$age) + 22.465206*log(konjac$totChol_t3) + -1.187731*log(konjac$HDL_t3) + 2.552905*log(konjac$systolic_t3) + -5.060998*log(konjac$age)*log(konjac$totChol_t3) +  - 146.5933061 + ifelse(konjac$medication_hypertension_t1 =="Yes", 0.420251, 0))


# Calculate changes in variables between time points (t2-t1 or t3-t1) ----
konjac$weight_deltat2 <- konjac$weight_t2 - konjac$weight_t1
konjac$weight_deltat3 <- konjac$weight_t3 - konjac$weight_t1
konjac$BMI_deltat2 <- konjac$BMI_t2 - konjac$BMI_t1
konjac$BMI_deltat3 <- konjac$BMI_t3 - konjac$BMI_t1
konjac$waist_delta <- konjac$waist_t3 - konjac$waist_t1
konjac$DEXA_MMT_delta <- konjac$DEXA_MMT_t3 - konjac$DEXA_MMT_t1
konjac$DEXA_per_GC_delta <- konjac$DEXA_per_GC_t3 - konjac$DEXA_per_GC_t1
konjac$DEXA_FMI_delta <- konjac$DEXA_FMI_t3 - konjac$DEXA_FMI_t1
konjac$DEXA_FFMI_delta <- konjac$DEXA_FFMI_t3 - konjac$DEXA_FFMI_t1
konjac$DEXA_AG_delta <- konjac$DEXA_AG_t3 - konjac$DEXA_AG_t1
konjac$DEXA_ASMMI_delta <- konjac$DEXA_ASMMI_t3 - konjac$DEXA_ASMMI_t1
konjac$DEXA_VAT_delta <- konjac$DEXA_VAT_t3 - konjac$DEXA_VAT_t1
konjac$HDL_delta <- konjac$HDL_t3 - konjac$HDL_t1
konjac$LDL_delta <- konjac$LDL_t3 - konjac$LDL_t1
konjac$totChol_delta <- konjac$totChol_t3 - konjac$totChol_t1
konjac$ateroindex_delta <- konjac$ateroindex_t3 - konjac$ateroindex_t1
konjac$triglycerides_delta <- konjac$triglycerides_t3 - konjac$triglycerides_t1
konjac$glycaemia_delta <- konjac$glycaemia_t3 - konjac$glycaemia_t1
konjac$HbA1c_delta <- konjac$HbA1c_t3 - konjac$HbA1c_t1
konjac$insulin_delta <- konjac$insulin_t3 - konjac$insulin_t1
konjac$homa_delta <- konjac$homa_t3 - konjac$homa_t1
konjac$systolic_delta <- konjac$systolic_t3 - konjac$systolic_t1
konjac$diastolic_delta <- konjac$diastolic_t3 - konjac$diastolic_t1
konjac$framingham_delta <- konjac$framingham_t3 - konjac$framingham_t1
konjac$hsCRP_delta <- konjac$hsCRP_t3 - konjac$hsCRP_t1
konjac$IL_18_delta <- konjac$IL_18_t3 - konjac$IL_18_t1
konjac$AgRP_ART_delta <- konjac$AgRP_ART_t3 - konjac$AgRP_ART_t1
konjac$Leptin_delta <- konjac$Leptin_t3 - konjac$Leptin_t1
konjac$Adiponectin_delta <- konjac$Adiponectin_t3 - konjac$Adiponectin_t1
konjac$Leptin_Adiponectin_delta <- konjac$Leptin_Adiponectin_t3 - konjac$Leptin_Adiponectin_t1
konjac$LBP_delta <- konjac$LBP_t3 - konjac$LBP_t1
konjac$KCAL_deltat2 <- konjac$KCAL_t2 - konjac$KCAL_t1
konjac$KCAL_deltat3 <- konjac$KCAL_t3 - konjac$KCAL_t1
konjac$KCALperkg_deltat2 <- konjac$KCALperkg_t2 - konjac$KCALperkg_t1
konjac$KCALperkg_deltat3 <- konjac$KCALperkg_t3 - konjac$KCALperkg_t1
konjac$CARB_deltat2 <- konjac$CARB_t2 - konjac$CARB_t1
konjac$CARB_deltat3 <- konjac$CARB_t3 - konjac$CARB_t1
konjac$CARBperkg_deltat2 <- konjac$CARBperkg_t2 - konjac$CARBperkg_t1
konjac$CARBperkg_deltat3 <- konjac$CARBperkg_t3 - konjac$CARBperkg_t1
konjac$CARBperc_deltat2 <- konjac$CARBperc_t2 - konjac$CARBperc_t1
konjac$CARBperc_deltat3 <- konjac$CARBperc_t3 - konjac$CARBperc_t1
konjac$PROT_deltat2 <- konjac$PROT_t2 - konjac$PROT_t1
konjac$PROT_deltat3 <- konjac$PROT_t3 - konjac$PROT_t1
konjac$PROTperkg_deltat2 <- konjac$PROTperkg_t2 - konjac$PROTperkg_t1
konjac$PROTperkg_deltat3 <- konjac$PROTperkg_t3 - konjac$PROTperkg_t1
konjac$PROTperc_deltat2 <- konjac$PROTperc_t2 - konjac$PROTperc_t1
konjac$PROTperc_deltat3 <- konjac$PROTperc_t3 - konjac$PROTperc_t1
konjac$TFAT_deltat2 <- konjac$TFAT_t2 - konjac$TFAT_t1
konjac$TFAT_deltat3 <- konjac$TFAT_t3 - konjac$TFAT_t1
konjac$TFATperkg_deltat2 <- konjac$TFATperkg_t2 - konjac$TFATperkg_t1
konjac$TFATperkg_deltat3 <- konjac$TFATperkg_t3 - konjac$TFATperkg_t1
konjac$TFATperc_deltat2 <- konjac$TFATperc_t2 - konjac$TFATperc_t1
konjac$TFATperc_deltat3 <- konjac$TFATperc_t3 - konjac$TFATperc_t1
konjac$FIBE_deltat2 <- konjac$FIBE_t2 - konjac$FIBE_t1
konjac$FIBE_deltat3 <- konjac$FIBE_t3 - konjac$FIBE_t1
konjac$FIBEperkg_deltat2 <- konjac$FIBEperkg_t2 - konjac$FIBEperkg_t1
konjac$FIBEperkg_deltat3 <- konjac$FIBEperkg_t3 - konjac$FIBEperkg_t1
konjac$SUGR_deltat2 <- konjac$SUGR_t2 - konjac$SUGR_t1
konjac$SUGR_deltat3 <- konjac$SUGR_t3 - konjac$SUGR_t1
konjac$SUGRperkg_deltat2 <- konjac$SUGRperkg_t2 - konjac$SUGRperkg_t1
konjac$SUGRperkg_deltat3 <- konjac$SUGRperkg_t3 - konjac$SUGRperkg_t1
konjac$acetic_delta <- konjac$acetic_t3 - konjac$acetic_t1
konjac$propionic_delta <- konjac$propionic_t3 - konjac$propionic_t1
konjac$butyric_delta <- konjac$butyric_t3 - konjac$butyric_t1
konjac$isobutyric_delta <- konjac$isobutyric_t3 - konjac$isobutyric_t1
konjac$valeric_delta <- konjac$valeric_t3 - konjac$valeric_t1


# Separate treatments ----
# FI236 = placebo; FI418 = konjac glucomannan
konjac_FI236 <- konjac[konjac$treatment =="FI236",]
konjac_FI418 <- konjac[konjac$treatment =="FI418",]

# Melt dataset for graphs
konjac_graphs.df_melt <- melt(plotly::select(konjac, starts_with("id") | starts_with("pair_match") | starts_with("treatment") | starts_with("sex") | starts_with("age") | !contains("DEXA")), id = c("id","pair_match","treatment","sex","age"))

konjac_graphs.df_melt$time <-
  ifelse(str_ends(konjac_graphs.df_melt$variable, "_t1")==TRUE, "t1",
         ifelse(str_ends(konjac_graphs.df_melt$variable, "_t2")==TRUE, "t2",
                ifelse(str_ends(konjac_graphs.df_melt$variable, "_t3")==TRUE, "t3", "ERROR!")))
konjac_graphs.df_melt$value <- as.numeric(konjac_graphs.df_melt$value)

treatment_names <- c('FI236' = "Control",
                     'FI418' = "Konjac")

# Table 1 ----
# PA: Double-check the number of subjects removed before obtaining the Table
table1(~ sex + age + BMI_t1 + waist_t1 + systolic_t1 + diastolic_t1 + HDL_t1 + triglycerides_t1 + glycaemia_t1 | treatment, data = konjac, overall=FALSE, render.continuous=my.render.cont)

# Sensitivity analyses ----
#konjac <- konjac %>%
#  plotly::filter(adh_sachets>0.80) %>%
#  plotly::filter(adherence=="yes")

```

# Mixed-effects models (LME)
```{r Mixed-effects models (LME)}
# Age (years) ----
shapiro.test(konjac$age)
fligner.test(konjac$age ~ konjac$treatment)
mt1 <- lm(age ~ treatment, data = konjac)
summary(mt1)
emmeans(mt1,  ~ treatment)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

age.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, age = konjac$age)

age.lme <- lme(age~treatment, random=~1|pair_match/id, data=age.df, method='REML')
summary(age.lme)
#random.effects(age.lme)
age.lsm <- emmeans(age.lme,  ~treatment)
age.lsm


# Anthropometry ----

### Body weight (kg) ----
# Baseline
shapiro.test(konjac$weight_t1)
fligner.test(konjac$weight_t1 ~ konjac$treatment)
mt1 <- lm(weight_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(konjac$weight_t3)
fligner.test(konjac$weight_t3 ~ konjac$treatment)
mt3 <- lm(weight_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$weight_deltat3)
fligner.test(konjac$weight_deltat3 ~ konjac$treatment)
mtd <- lm(weight_deltat3 ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
weight.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$weight_t1, t3 = konjac$weight_t3)
weight.df <- weight.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "weight")
weight.df <- na.omit(weight.df)

weight.lme <- lme(weight~treatment*time, random=~1|pair_match/id, data=weight.df, method='REML')
summary(weight.lme)
#random.effects(weight.lme)
weight.lsm <- emmeans(weight.lme,  ~treatment*time)
weight.lsm

weight.lme.plot1 <- ggplot(data = as.data.frame(weight.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Body weight (kg)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

weight.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$weight_deltat3)
weight.df <- na.omit(weight.df)

weight.lme <- lme(delta~treatment, random=~1|pair_match/id, data=weight.df, method='REML')
summary(weight.lme)
#random.effects(weight.lme)
weight.lsm <- emmeans(weight.lme,  ~treatment)
weight.lsm

weight.lme.plot2 <- ggplot(data = as.data.frame(weight.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change body weight (kg)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(weight.lme.plot1, weight.lme.plot2, rel_widths = c(2, 1))

# Control
weight.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$weight_t1, t3 = konjac_FI236$weight_t3)
weight.df <- weight.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "weight")
weight.df <- na.omit(weight.df)

weight.lme <- lme(weight~time, random=~1|pair_match/id, data=weight.df, method='REML')
summary(weight.lme)

# Konjac
weight.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$weight_t1, t3 = konjac_FI418$weight_t3)
weight.df <- weight.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "weight")
weight.df <- na.omit(weight.df)

weight.lme <- lme(weight~time, random=~1|pair_match/id, data=weight.df, method='REML')
summary(weight.lme)


### BMI (kg/m2) ----
# Baseline
shapiro.test(konjac$BMI_t1)
fligner.test(konjac$BMI_t1 ~ konjac$treatment)
mt1 <- lm(BMI_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(konjac$BMI_t3)
fligner.test(konjac$BMI_t3 ~ konjac$treatment)
mt3 <- lm(BMI_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$BMI_deltat3)
fligner.test(konjac$BMI_deltat3 ~ konjac$treatment)
mtd <- lm(BMI_deltat3 ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
BMI.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$BMI_t1, t3 = konjac$BMI_t3)
BMI.df <- BMI.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "BMI")
BMI.df <- na.omit(BMI.df)

BMI.lme <- lme(BMI~treatment*time, random=~1|pair_match/id, data=BMI.df, method='REML')
summary(BMI.lme)
#random.effects(BMI.lme)
BMI.lsm <- emmeans(BMI.lme,  ~treatment*time)
BMI.lsm

BMI.lme.plot1 <- ggplot(data = as.data.frame(BMI.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = bquote("BMI "~(kg/m^2))) +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

BMI.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$BMI_deltat3)
BMI.df <- na.omit(BMI.df)

BMI.lme <- lme(delta~treatment, random=~1|pair_match/id, data=BMI.df, method='REML')
summary(BMI.lme)
#random.effects(BMI.lme)
BMI.lsm <- emmeans(BMI.lme,  ~treatment)
BMI.lsm

BMI.lme.plot2 <- ggplot(data = as.data.frame(BMI.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = bquote("Change BMI "~(kg/m^2))) +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(BMI.lme.plot1, BMI.lme.plot2, rel_widths = c(2, 1))

# Control
BMI.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$BMI_t1, t3 = konjac_FI236$BMI_t3)
BMI.df <- BMI.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "BMI")
BMI.df <- na.omit(BMI.df)

BMI.lme <- lme(BMI~time, random=~1|pair_match/id, data=BMI.df, method='REML')
summary(BMI.lme)

# Konjac
BMI.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$BMI_t1, t3 = konjac_FI418$BMI_t3)
BMI.df <- BMI.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "BMI")
BMI.df <- na.omit(BMI.df)

BMI.lme <- lme(BMI~time, random=~1|pair_match/id, data=BMI.df, method='REML')
summary(BMI.lme)


### Waist circumference (cm) ----
# Baseline
shapiro.test(konjac$waist_t1)
fligner.test(konjac$waist_t1 ~ konjac$treatment)
mt1 <- lm(waist_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(konjac$waist_t3)
fligner.test(konjac$waist_t3 ~ konjac$treatment)
mt3 <- lm(waist_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$waist_delta)
fligner.test(konjac$waist_delta ~ konjac$treatment)
mtd <- lm(waist_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
waist.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$waist_t1, t3 = konjac$waist_t3)
waist.df <- waist.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "waist")
waist.df <- na.omit(waist.df)

waist.lme <- lme(waist~treatment*time, random=~1|pair_match/id, data=waist.df, method='REML')
summary(waist.lme)
#random.effects(waist.lme)
waist.lsm <- emmeans(waist.lme,  ~treatment*time)
waist.lsm

waist.lme.plot1 <- ggplot(data = as.data.frame(waist.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Waist circumference (cm)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

waist.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$waist_delta)
waist.df <- na.omit(waist.df)

waist.lme <- lme(delta~treatment, random=~1|pair_match/id, data=waist.df, method='REML')
summary(waist.lme)
#random.effects(waist.lme)
waist.lsm <- emmeans(waist.lme,  ~treatment)
waist.lsm

waist.lme.plot2 <- ggplot(data = as.data.frame(waist.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change waist circumference (cm)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(waist.lme.plot1, waist.lme.plot2, rel_widths = c(2, 1))

# Control
waist.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$waist_t1, t3 = konjac_FI236$waist_t3)
waist.df <- waist.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "waist")
waist.df <- na.omit(waist.df)

waist.lme <- lme(waist~time, random=~1|pair_match/id, data=waist.df, method='REML')
summary(waist.lme)

# Konjac
waist.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$waist_t1, t3 = konjac_FI418$waist_t3)
waist.df <- waist.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "waist")
waist.df <- na.omit(waist.df)

waist.lme <- lme(waist~time, random=~1|pair_match/id, data=waist.df, method='REML')
summary(waist.lme)


# DEXA ----

### DEXA Total Muscular Mass (kg) ----
# Baseline
shapiro.test(log(konjac$DEXA_MMT_t1))
fligner.test(log(konjac$DEXA_MMT_t1) ~ konjac$treatment)
mt1 <- lm(log(DEXA_MMT_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$DEXA_MMT_t3))
fligner.test(log(konjac$DEXA_MMT_t3) ~ konjac$treatment)
mt3 <- lm(log(DEXA_MMT_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$DEXA_MMT_delta)
fligner.test(konjac$DEXA_MMT_delta ~ konjac$treatment)
mtd <- lm(DEXA_MMT_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
DEXA_MMT.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$DEXA_MMT_t1, t3 = konjac$DEXA_MMT_t3)
DEXA_MMT.df <- DEXA_MMT.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "DEXA_MMT")
DEXA_MMT.df <- na.omit(DEXA_MMT.df)

DEXA_MMT.lme <- lme(log(DEXA_MMT)~treatment*time, random=~1|pair_match/id, data=DEXA_MMT.df, method='REML')
summary(DEXA_MMT.lme)
#random.effects(DEXA_MMT.lme)
DEXA_MMT.lsm <- emmeans(DEXA_MMT.lme,  ~treatment*time, type="response")
DEXA_MMT.lsm

DEXA_MMT.lme.plot1 <- ggplot(data = as.data.frame(DEXA_MMT.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "DEXA Total\nMuscular Mass (kg)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

DEXA_MMT.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$DEXA_MMT_delta)
DEXA_MMT.df <- na.omit(DEXA_MMT.df)

DEXA_MMT.lme <- lme(delta~treatment, random=~1|pair_match/id, data=DEXA_MMT.df, method='REML')
summary(DEXA_MMT.lme)
#random.effects(DEXA_MMT.lme)
DEXA_MMT.lsm <- emmeans(DEXA_MMT.lme,  ~treatment)
DEXA_MMT.lsm

DEXA_MMT.lme.plot2 <- ggplot(data = as.data.frame(DEXA_MMT.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change DEXA Total\nMuscular Mass (kg)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(DEXA_MMT.lme.plot1, DEXA_MMT.lme.plot2, rel_widths = c(2, 1))

# Control
DEXA_MMT.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$DEXA_MMT_t1, t3 = konjac_FI236$DEXA_MMT_t3)
DEXA_MMT.df <- DEXA_MMT.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "DEXA_MMT")
DEXA_MMT.df <- na.omit(DEXA_MMT.df)

DEXA_MMT.lme <- lme(log(DEXA_MMT)~time, random=~1|pair_match/id, data=DEXA_MMT.df, method='REML')
summary(DEXA_MMT.lme)

# Konjac
DEXA_MMT.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$DEXA_MMT_t1, t3 = konjac_FI418$DEXA_MMT_t3)
DEXA_MMT.df <- DEXA_MMT.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "DEXA_MMT")
DEXA_MMT.df <- na.omit(DEXA_MMT.df)

DEXA_MMT.lme <- lme(log(DEXA_MMT)~time, random=~1|pair_match/id, data=DEXA_MMT.df, method='REML')
summary(DEXA_MMT.lme)


### DEXA Visceral fat area (cm2) ----
# Baseline
shapiro.test(log(konjac$DEXA_VAT_t1))
fligner.test(log(konjac$DEXA_VAT_t1) ~ konjac$treatment)
mt1 <- lm(log(konjac$DEXA_VAT_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$DEXA_VAT_t3))
fligner.test(log(konjac$DEXA_VAT_t3) ~ konjac$treatment)
mt3 <- lm(log(DEXA_VAT_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$DEXA_VAT_delta)
fligner.test(konjac$DEXA_VAT_delta ~ konjac$treatment)
mtd <- lm(DEXA_VAT_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
DEXA_VAT.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$DEXA_VAT_t1, t3 = konjac$DEXA_VAT_t3)
DEXA_VAT.df <- DEXA_VAT.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "DEXA_VAT")
DEXA_VAT.df <- na.omit(DEXA_VAT.df)

DEXA_VAT.lme <- lme(log(DEXA_VAT)~treatment*time, random=~1|pair_match/id, data=DEXA_VAT.df, method='REML')
summary(DEXA_VAT.lme)
#random.effects(DEXA_VAT.lme)
DEXA_VAT.lsm <- emmeans(DEXA_VAT.lme,  ~treatment*time, type="response")
DEXA_VAT.lsm

DEXA_VAT.lme.plot1 <- ggplot(data = as.data.frame(DEXA_VAT.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = bquote("DEXA VAT "~(cm^2))) +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

DEXA_VAT.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$DEXA_VAT_delta)
DEXA_VAT.df <- na.omit(DEXA_VAT.df)

DEXA_VAT.lme <- lme(delta~treatment, random=~1|pair_match/id, data=DEXA_VAT.df, method='REML')
summary(DEXA_VAT.lme)
#random.effects(DEXA_VAT.lme)
DEXA_VAT.lsm <- emmeans(DEXA_VAT.lme,  ~treatment)
DEXA_VAT.lsm

DEXA_VAT.lme.plot2 <- ggplot(data = as.data.frame(DEXA_VAT.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = bquote("Change DEXA VAT "~(cm^2))) +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(DEXA_VAT.lme.plot1, DEXA_VAT.lme.plot2, rel_widths = c(2, 1))

# Control
DEXA_VAT.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$DEXA_VAT_t1, t3 = konjac_FI236$DEXA_VAT_t3)
DEXA_VAT.df <- DEXA_VAT.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "DEXA_VAT")
DEXA_VAT.df <- na.omit(DEXA_VAT.df)

DEXA_VAT.lme <- lme(log(DEXA_VAT)~time, random=~1|pair_match/id, data=DEXA_VAT.df, method='REML')
summary(DEXA_VAT.lme)

# Konjac
DEXA_VAT.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$DEXA_VAT_t1, t3 = konjac_FI418$DEXA_VAT_t3)
DEXA_VAT.df <- DEXA_VAT.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "DEXA_VAT")
DEXA_VAT.df <- na.omit(DEXA_VAT.df)

DEXA_VAT.lme <- lme(log(DEXA_VAT)~time, random=~1|pair_match/id, data=DEXA_VAT.df, method='REML')
summary(DEXA_VAT.lme)


### DEXA Body Fat (%) ----
# Baseline
b <- boxcox(lm(konjac$DEXA_per_GC_t1 ~ 1))
lambda <- b$x[which.max(b$y)]
# new_x_exact <- (x ^ lambda - 1) / lambda
shapiro.test((konjac$DEXA_per_GC_t1^lambda - 1)/lambda)
fligner.test((konjac$DEXA_per_GC_t1^lambda - 1)/lambda ~ konjac$treatment)
mt1 <- lm((konjac$DEXA_per_GC_t1^lambda - 1)/lambda ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
b <- boxcox(lm(konjac$DEXA_per_GC_t3 ~ 1))
lambda <- b$x[which.max(b$y)]
# new_x_exact <- (x ^ lambda - 1) / lambda
shapiro.test((konjac$DEXA_per_GC_t3^lambda - 1)/lambda)
fligner.test((konjac$DEXA_per_GC_t3^lambda - 1)/lambda ~ konjac$treatment)
mt3 <- lm((konjac$DEXA_per_GC_t3^lambda - 1)/lambda ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$DEXA_per_GC_delta)
fligner.test(konjac$DEXA_per_GC_delta ~ konjac$treatment)
mtd <- lm(DEXA_per_GC_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
DEXA_per_GC.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$DEXA_per_GC_t1, t3 = konjac$DEXA_per_GC_t3)
DEXA_per_GC.df <- DEXA_per_GC.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "DEXA_per_GC")
DEXA_per_GC.df <- na.omit(DEXA_per_GC.df)

DEXA_per_GC.lme <- lme(DEXA_per_GC/2~treatment*time, random=~1|pair_match/id, data=DEXA_per_GC.df, method='REML')
summary(DEXA_per_GC.lme)
#random.effects(DEXA_per_GC.lme)
DEXA_per_GC.lsm <- emmeans(DEXA_per_GC.lme,  ~treatment*time) # multiply by 2 to get estimates
DEXA_per_GC.lsm

DEXA_per_GC.lme.plot1 <- ggplot(data = as.data.frame(DEXA_per_GC.lsm), aes(x = time, y = emmean*2)) +
  geom_errorbar(aes(ymin = lower.CL*2, ymax = upper.CL*2), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "DEXA Body Fat (%)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

DEXA_per_GC.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$DEXA_per_GC_delta)
DEXA_per_GC.df <- na.omit(DEXA_per_GC.df)

DEXA_per_GC.lme <- lme(delta~treatment, random=~1|pair_match/id, data=DEXA_per_GC.df, method='REML')
summary(DEXA_per_GC.lme)
#random.effects(DEXA_per_GC.lme)
DEXA_per_GC.lsm <- emmeans(DEXA_per_GC.lme,  ~treatment)
DEXA_per_GC.lsm

DEXA_per_GC.lme.plot2 <- ggplot(data = as.data.frame(DEXA_per_GC.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change DEXA Body Fat (%)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(DEXA_per_GC.lme.plot1, DEXA_per_GC.lme.plot2, rel_widths = c(2, 1))

# Control
DEXA_per_GC.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$DEXA_per_GC_t1, t3 = konjac_FI236$DEXA_per_GC_t3)
DEXA_per_GC.df <- DEXA_per_GC.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "DEXA_per_GC")
DEXA_per_GC.df <- na.omit(DEXA_per_GC.df)

DEXA_per_GC.lme <- lme(DEXA_per_GC/2~time, random=~1|pair_match/id, data=DEXA_per_GC.df, method='REML')
summary(DEXA_per_GC.lme)

# Konjac
DEXA_per_GC.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$DEXA_per_GC_t1, t3 = konjac_FI418$DEXA_per_GC_t3)
DEXA_per_GC.df <- DEXA_per_GC.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "DEXA_per_GC")
DEXA_per_GC.df <- na.omit(DEXA_per_GC.df)

DEXA_per_GC.lme <- lme(DEXA_per_GC/2~time, random=~1|pair_match/id, data=DEXA_per_GC.df, method='REML')
summary(DEXA_per_GC.lme)


### DEXA Fat Mass Index (kg/m2) ----
# Baseline
shapiro.test(konjac$DEXA_FMI_t1)
fligner.test(konjac$DEXA_FMI_t1 ~ konjac$treatment)
mt1 <- lm(DEXA_FMI_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(konjac$DEXA_FMI_t3)
fligner.test(konjac$DEXA_FMI_t3 ~ konjac$treatment)
mt3 <- lm(DEXA_FMI_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$DEXA_FMI_delta)
fligner.test(konjac$DEXA_FMI_delta ~ konjac$treatment)
mtd <- lm(DEXA_FMI_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
DEXA_FMI.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$DEXA_FMI_t1, t3 = konjac$DEXA_FMI_t3)
DEXA_FMI.df <- DEXA_FMI.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "DEXA_FMI")
DEXA_FMI.df <- na.omit(DEXA_FMI.df)

DEXA_FMI.lme <- lme(DEXA_FMI~treatment*time, random=~1|pair_match/id, data=DEXA_FMI.df, method='REML')
summary(DEXA_FMI.lme)
#random.effects(DEXA_FMI.lme)
DEXA_FMI.lsm <- emmeans(DEXA_FMI.lme,  ~treatment*time)
DEXA_FMI.lsm

DEXA_FMI.lme.plot1 <- ggplot(data = as.data.frame(DEXA_FMI.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = bquote("DEXA FMI "~(kg/m^2))) +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

DEXA_FMI.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$DEXA_FMI_delta)
DEXA_FMI.df <- na.omit(DEXA_FMI.df)

DEXA_FMI.lme <- lme(delta~treatment, random=~1|pair_match/id, data=DEXA_FMI.df, method='REML')
summary(DEXA_FMI.lme)
#random.effects(DEXA_FMI.lme)
DEXA_FMI.lsm <- emmeans(DEXA_FMI.lme,  ~treatment)
DEXA_FMI.lsm

DEXA_FMI.lme.plot2 <- ggplot(data = as.data.frame(DEXA_FMI.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = bquote("Change DEXA FMI "~(kg/m^2))) +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(DEXA_FMI.lme.plot1, DEXA_FMI.lme.plot2, rel_widths = c(2, 1))

# Control
DEXA_FMI.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$DEXA_FMI_t1, t3 = konjac_FI236$DEXA_FMI_t3)
DEXA_FMI.df <- DEXA_FMI.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "DEXA_FMI")
DEXA_FMI.df <- na.omit(DEXA_FMI.df)

DEXA_FMI.lme <- lme(DEXA_FMI~time, random=~1|pair_match/id, data=DEXA_FMI.df, method='REML')
summary(DEXA_FMI.lme)

# Konjac
DEXA_FMI.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$DEXA_FMI_t1, t3 = konjac_FI418$DEXA_FMI_t3)
DEXA_FMI.df <- DEXA_FMI.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "DEXA_FMI")
DEXA_FMI.df <- na.omit(DEXA_FMI.df)

DEXA_FMI.lme <- lme(DEXA_FMI~time, random=~1|pair_match/id, data=DEXA_FMI.df, method='REML')
summary(DEXA_FMI.lme)


### DEXA Free Fat Mass Index (kg/m2) ----
# Baseline
shapiro.test(log(konjac$DEXA_FFMI_t1))
fligner.test(log(konjac$DEXA_FFMI_t1) ~ konjac$treatment)
mt1 <- lm(log(DEXA_FFMI_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$DEXA_FFMI_t3))
fligner.test(log(konjac$DEXA_FFMI_t3) ~ konjac$treatment)
mt3 <- lm(log(DEXA_FFMI_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$DEXA_FFMI_delta)
fligner.test(konjac$DEXA_FFMI_delta ~ konjac$treatment)
mtd <- lm(DEXA_FFMI_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
DEXA_FFMI.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$DEXA_FFMI_t1, t3 = konjac$DEXA_FFMI_t3)
DEXA_FFMI.df <- DEXA_FFMI.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "DEXA_FFMI")
DEXA_FFMI.df <- na.omit(DEXA_FFMI.df)

DEXA_FFMI.lme <- lme(log(DEXA_FFMI)~treatment*time, random=~1|pair_match/id, data=DEXA_FFMI.df, method='REML')
summary(DEXA_FFMI.lme)
#random.effects(DEXA_FFMI.lme)
DEXA_FFMI.lsm <- emmeans(DEXA_FFMI.lme, ~treatment*time, type="response")
DEXA_FFMI.lsm

DEXA_FFMI.lme.plot1 <- ggplot(data = as.data.frame(DEXA_FFMI.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = bquote("DEXA FFMI "~(kg/m^2))) +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

DEXA_FFMI.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$DEXA_FFMI_delta)
DEXA_FFMI.df <- na.omit(DEXA_FFMI.df)

DEXA_FFMI.lme <- lme(delta~treatment, random=~1|pair_match/id, data=DEXA_FFMI.df, method='REML')
summary(DEXA_FFMI.lme)
#random.effects(DEXA_FFMI.lme)
DEXA_FFMI.lsm <- emmeans(DEXA_FFMI.lme,  ~treatment)
DEXA_FFMI.lsm

DEXA_FFMI.lme.plot2 <- ggplot(data = as.data.frame(DEXA_FFMI.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = bquote("Change DEXA FFMI "~(kg/m^2))) +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(DEXA_FFMI.lme.plot1, DEXA_FFMI.lme.plot2, rel_widths = c(2, 1))

# Control
DEXA_FFMI.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$DEXA_FFMI_t1, t3 = konjac_FI236$DEXA_FFMI_t3)
DEXA_FFMI.df <- DEXA_FFMI.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "DEXA_FFMI")
DEXA_FFMI.df <- na.omit(DEXA_FFMI.df)

DEXA_FFMI.lme <- lme(log(DEXA_FFMI)~time, random=~1|pair_match/id, data=DEXA_FFMI.df, method='REML')
summary(DEXA_FFMI.lme)

# Konjac
DEXA_FFMI.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$DEXA_FFMI_t1, t3 = konjac_FI418$DEXA_FFMI_t3)
DEXA_FFMI.df <- DEXA_FFMI.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "DEXA_FFMI")
DEXA_FFMI.df <- na.omit(DEXA_FFMI.df)

DEXA_FFMI.lme <- lme(log(DEXA_FFMI)~time, random=~1|pair_match/id, data=DEXA_FFMI.df, method='REML')
summary(DEXA_FFMI.lme)


### DEXA Android/Gynoid ratio ----
# Baseline
shapiro.test(konjac$DEXA_AG_t1)
fligner.test(konjac$DEXA_AG_t1 ~ konjac$treatment)
mt1 <- lm(DEXA_AG_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(konjac$DEXA_AG_t3)
fligner.test(konjac$DEXA_AG_t3 ~ konjac$treatment)
mt3 <- lm(DEXA_AG_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$DEXA_AG_delta)
fligner.test(konjac$DEXA_AG_delta ~ konjac$treatment)
mtd <- lm(DEXA_AG_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
DEXA_AG.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$DEXA_AG_t1, t3 = konjac$DEXA_AG_t3)
DEXA_AG.df <- DEXA_AG.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "DEXA_AG")
DEXA_AG.df <- na.omit(DEXA_AG.df)

DEXA_AG.lme <- lme(DEXA_AG~treatment*time, random=~1|pair_match/id, data=DEXA_AG.df, method='REML')
summary(DEXA_AG.lme)
#random.effects(DEXA_AG.lme)
DEXA_AG.lsm <- emmeans(DEXA_AG.lme,  ~treatment*time)
DEXA_AG.lsm

DEXA_AG.lme.plot1 <- ggplot(data = as.data.frame(DEXA_AG.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "DEXA Android/Gynoid") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

DEXA_AG.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$DEXA_AG_delta)
DEXA_AG.df <- na.omit(DEXA_AG.df)

DEXA_AG.lme <- lme(delta~treatment, random=~1|pair_match/id, data=DEXA_AG.df, method='REML')
summary(DEXA_AG.lme)
#random.effects(DEXA_AG.lme)
DEXA_AG.lsm <- emmeans(DEXA_AG.lme,  ~treatment)
DEXA_AG.lsm

DEXA_AG.lme.plot2 <- ggplot(data = as.data.frame(DEXA_AG.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change DEXA Android/Gynoid") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(DEXA_AG.lme.plot1, DEXA_AG.lme.plot2, rel_widths = c(2, 1))

# Control
DEXA_AG.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$DEXA_AG_t1, t3 = konjac_FI236$DEXA_AG_t3)
DEXA_AG.df <- DEXA_AG.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "DEXA_AG")
DEXA_AG.df <- na.omit(DEXA_AG.df)

DEXA_AG.lme <- lme(DEXA_AG~time, random=~1|pair_match/id, data=DEXA_AG.df, method='REML')
summary(DEXA_AG.lme)

# Konjac
DEXA_AG.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$DEXA_AG_t1, t3 = konjac_FI418$DEXA_AG_t3)
DEXA_AG.df <- DEXA_AG.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "DEXA_AG")
DEXA_AG.df <- na.omit(DEXA_AG.df)

DEXA_AG.lme <- lme(DEXA_AG~time, random=~1|pair_match/id, data=DEXA_AG.df, method='REML')
summary(DEXA_AG.lme)


### DEXA Appendicular skeletal muscle mass index (kg/m2) ----
# Baseline
shapiro.test(log(konjac$DEXA_ASMMI_t1))
fligner.test(log(konjac$DEXA_ASMMI_t1) ~ konjac$treatment)
mt1 <- lm(log(DEXA_ASMMI_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$DEXA_ASMMI_t3))
fligner.test(log(konjac$DEXA_ASMMI_t3) ~ konjac$treatment)
mt3 <- lm(log(DEXA_ASMMI_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$DEXA_ASMMI_delta)
fligner.test(konjac$DEXA_ASMMI_delta ~ konjac$treatment)
mtd <- lm(DEXA_ASMMI_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
DEXA_ASMMI.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$DEXA_ASMMI_t1, t3 = konjac$DEXA_ASMMI_t3)
DEXA_ASMMI.df <- DEXA_ASMMI.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "DEXA_ASMMI")
DEXA_ASMMI.df <- na.omit(DEXA_ASMMI.df)

DEXA_ASMMI.lme <- lme(log(DEXA_ASMMI)~treatment*time, random=~1|pair_match/id, data=DEXA_ASMMI.df, method='REML')
summary(DEXA_ASMMI.lme)
#random.effects(DEXA_ASMMI.lme)
DEXA_ASMMI.lsm <- emmeans(DEXA_ASMMI.lme, ~treatment*time, type="response")
DEXA_ASMMI.lsm

DEXA_ASMMI.lme.plot1 <- ggplot(data = as.data.frame(DEXA_ASMMI.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = bquote("DEXA ASMMI "~(kg/m^2))) +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

DEXA_ASMMI.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$DEXA_ASMMI_delta)
DEXA_ASMMI.df <- na.omit(DEXA_ASMMI.df)

DEXA_ASMMI.lme <- lme(delta~treatment, random=~1|pair_match/id, data=DEXA_ASMMI.df, method='REML')
summary(DEXA_ASMMI.lme)
#random.effects(DEXA_ASMMI.lme)
DEXA_ASMMI.lsm <- emmeans(DEXA_ASMMI.lme,  ~treatment)
DEXA_ASMMI.lsm

DEXA_ASMMI.lme.plot2 <- ggplot(data = as.data.frame(DEXA_ASMMI.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = bquote("Change DEXA ASMMI "~(kg/m^2))) +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(DEXA_ASMMI.lme.plot1, DEXA_ASMMI.lme.plot2, rel_widths = c(2, 1))

# Control
DEXA_ASMMI.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$DEXA_ASMMI_t1, t3 = konjac_FI236$DEXA_ASMMI_t3)
DEXA_ASMMI.df <- DEXA_ASMMI.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "DEXA_ASMMI")
DEXA_ASMMI.df <- na.omit(DEXA_ASMMI.df)

DEXA_ASMMI.lme <- lme(log(DEXA_ASMMI)~time, random=~1|pair_match/id, data=DEXA_ASMMI.df, method='REML')
summary(DEXA_ASMMI.lme)

# Konjac
DEXA_ASMMI.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$DEXA_ASMMI_t1, t3 = konjac_FI418$DEXA_ASMMI_t3)
DEXA_ASMMI.df <- DEXA_ASMMI.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "DEXA_ASMMI")
DEXA_ASMMI.df <- na.omit(DEXA_ASMMI.df)

DEXA_ASMMI.lme <- lme(log(DEXA_ASMMI)~time, random=~1|pair_match/id, data=DEXA_ASMMI.df, method='REML')
summary(DEXA_ASMMI.lme)


# Lipid profile ----

### HDL (mg/dL) ----
# Baseline
shapiro.test(konjac$HDL_t1)
fligner.test(konjac$HDL_t1 ~ konjac$treatment)
mt1 <- lm(HDL_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(konjac$HDL_t3)
fligner.test(konjac$HDL_t3 ~ konjac$treatment)
mt3 <- lm(HDL_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$HDL_delta)
fligner.test(konjac$HDL_delta ~ konjac$treatment)
mtd <- lm(HDL_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
HDL.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$HDL_t1, t3 = konjac$HDL_t3)
HDL.df <- HDL.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "HDL")
HDL.df <- na.omit(HDL.df)

HDL.lme <- lme(HDL~treatment*time, random=~1|pair_match/id, data=HDL.df, method='REML')
summary(HDL.lme)
#random.effects(HDL.lme)
HDL.lsm <- emmeans(HDL.lme,  ~treatment*time)
HDL.lsm

HDL.lme.plot1 <- ggplot(data = as.data.frame(HDL.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "HDL (mg/dL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

HDL.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$HDL_delta)
HDL.df <- na.omit(HDL.df)

HDL.lme <- lme(delta~treatment, random=~1|pair_match/id, data=HDL.df, method='REML')
summary(HDL.lme)
#random.effects(HDL.lme)
HDL.lsm <- emmeans(HDL.lme,  ~treatment)
HDL.lsm

HDL.lme.plot2 <- ggplot(data = as.data.frame(HDL.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change HDL (mg/dL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(HDL.lme.plot1, HDL.lme.plot2, rel_widths = c(2, 1))

# Control
HDL.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$HDL_t1, t3 = konjac_FI236$HDL_t3)
HDL.df <- HDL.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "HDL")
HDL.df <- na.omit(HDL.df)

HDL.lme <- lme(HDL~time, random=~1|pair_match/id, data=HDL.df, method='REML')
summary(HDL.lme)

# Konjac
HDL.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$HDL_t1, t3 = konjac_FI418$HDL_t3)
HDL.df <- HDL.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "HDL")
HDL.df <- na.omit(HDL.df)

HDL.lme <- lme(HDL~time, random=~1|pair_match/id, data=HDL.df, method='REML')
summary(HDL.lme)


### LDL (mg/dL) ----
# Baseline
shapiro.test(konjac$LDL_t1)
fligner.test(konjac$LDL_t1 ~ konjac$treatment)
mt1 <- lm(LDL_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(konjac$LDL_t3)
fligner.test(konjac$LDL_t3 ~ konjac$treatment)
mt3 <- lm(LDL_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$LDL_delta)
fligner.test(konjac$LDL_delta ~ konjac$treatment)
mtd <- lm(LDL_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
LDL.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$LDL_t1, t3 = konjac$LDL_t3)
LDL.df <- LDL.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "LDL")
LDL.df <- na.omit(LDL.df)

LDL.lme <- lme(LDL~treatment*time, random=~1|pair_match/id, data=LDL.df, method='REML')
summary(LDL.lme)
#random.effects(LDL.lme)
LDL.lsm <- emmeans(LDL.lme,  ~treatment*time)
LDL.lsm

LDL.lme.plot1 <- ggplot(data = as.data.frame(LDL.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "LDL (mg/dL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

LDL.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$LDL_delta)
LDL.df <- na.omit(LDL.df)

LDL.lme <- lme(delta~treatment, random=~1|pair_match/id, data=LDL.df, method='REML')
summary(LDL.lme)
#random.effects(LDL.lme)
LDL.lsm <- emmeans(LDL.lme,  ~treatment)
LDL.lsm

LDL.lme.plot2 <- ggplot(data = as.data.frame(LDL.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change LDL (mg/dL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(LDL.lme.plot1, LDL.lme.plot2, rel_widths = c(2, 1))

# Control
LDL.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$LDL_t1, t3 = konjac_FI236$LDL_t3)
LDL.df <- LDL.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "LDL")
LDL.df <- na.omit(LDL.df)

LDL.lme <- lme(LDL~time, random=~1|pair_match/id, data=LDL.df, method='REML')
summary(LDL.lme)

# Konjac
LDL.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$LDL_t1, t3 = konjac_FI418$LDL_t3)
LDL.df <- LDL.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "LDL")
LDL.df <- na.omit(LDL.df)

LDL.lme <- lme(LDL~time, random=~1|pair_match/id, data=LDL.df, method='REML')
summary(LDL.lme)


### Total cholesterol (mg/dL) ----
# Baseline
shapiro.test(konjac$totChol_t1)
fligner.test(konjac$totChol_t1 ~ konjac$treatment)
mt1 <- lm(totChol_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(konjac$totChol_t3)
fligner.test(konjac$totChol_t3 ~ konjac$treatment)
mt3 <- lm(totChol_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$totChol_delta)
fligner.test(konjac$totChol_delta ~ konjac$treatment)
mtd <- lm(totChol_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
totChol.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$totChol_t1, t3 = konjac$totChol_t3)
totChol.df <- totChol.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "totChol")
totChol.df <- na.omit(totChol.df)

totChol.lme <- lme(totChol~treatment*time, random=~1|pair_match/id, data=totChol.df, method='REML')
summary(totChol.lme)
#random.effects(totChol.lme)
totChol.lsm <- emmeans(totChol.lme,  ~treatment*time)
totChol.lsm

totChol.lme.plot1 <- ggplot(data = as.data.frame(totChol.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Total cholesterol (mg/dL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

totChol.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$totChol_delta)
totChol.df <- na.omit(totChol.df)

totChol.lme <- lme(delta~treatment, random=~1|pair_match/id, data=totChol.df, method='REML')
summary(totChol.lme)
#random.effects(totChol.lme)
totChol.lsm <- emmeans(totChol.lme,  ~treatment)
totChol.lsm

totChol.lme.plot2 <- ggplot(data = as.data.frame(totChol.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change total cholesterol (mg/dL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(totChol.lme.plot1, totChol.lme.plot2, rel_widths = c(2, 1))

# Control
totChol.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$totChol_t1, t3 = konjac_FI236$totChol_t3)
totChol.df <- totChol.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "totChol")
totChol.df <- na.omit(totChol.df)

totChol.lme <- lme(totChol~time, random=~1|pair_match/id, data=totChol.df, method='REML')
summary(totChol.lme)

# Konjac
totChol.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$totChol_t1, t3 = konjac_FI418$totChol_t3)
totChol.df <- totChol.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "totChol")
totChol.df <- na.omit(totChol.df)

totChol.lme <- lme(totChol~time, random=~1|pair_match/id, data=totChol.df, method='REML')
summary(totChol.lme)


### Atherogenic index (adimensional) ----
# Baseline
shapiro.test(log(konjac$ateroindex_t1))
fligner.test(log(konjac$ateroindex_t1) ~ konjac$treatment)
mt1 <- lm(log(ateroindex_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$ateroindex_t3))
fligner.test(log(konjac$ateroindex_t3) ~ konjac$treatment)
mt3 <- lm(log(ateroindex_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$ateroindex_delta)
fligner.test(konjac$ateroindex_delta ~ konjac$treatment)
mtd <- lm(ateroindex_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
ateroindex.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$ateroindex_t1, t3 = konjac$ateroindex_t3)
ateroindex.df <- ateroindex.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "ateroindex")
ateroindex.df <- na.omit(ateroindex.df)

ateroindex.lme <- lme(log(ateroindex)~treatment*time, random=~1|pair_match/id, data=ateroindex.df, method='REML')
summary(ateroindex.lme)
#random.effects(ateroindex.lme)
ateroindex.lsm <- emmeans(ateroindex.lme, ~treatment*time, type="response")
ateroindex.lsm

ateroindex.lme.plot1 <- ggplot(data = as.data.frame(ateroindex.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Atherogenic index") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

ateroindex.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$ateroindex_delta)
ateroindex.df <- na.omit(ateroindex.df)

ateroindex.lme <- lme(delta~treatment, random=~1|pair_match/id, data=ateroindex.df, method='REML')
summary(ateroindex.lme)
#random.effects(ateroindex.lme)
ateroindex.lsm <- emmeans(ateroindex.lme,  ~treatment)
ateroindex.lsm

ateroindex.lme.plot2 <- ggplot(data = as.data.frame(ateroindex.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change atherogenic index") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(ateroindex.lme.plot1, ateroindex.lme.plot2, rel_widths = c(2, 1))

# Control
ateroindex.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$ateroindex_t1, t3 = konjac_FI236$ateroindex_t3)
ateroindex.df <- ateroindex.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "ateroindex")
ateroindex.df <- na.omit(ateroindex.df)

ateroindex.lme <- lme(log(ateroindex)~time, random=~1|pair_match/id, data=ateroindex.df, method='REML')
summary(ateroindex.lme)

# Konjac
ateroindex.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$ateroindex_t1, t3 = konjac_FI418$ateroindex_t3)
ateroindex.df <- ateroindex.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "ateroindex")
ateroindex.df <- na.omit(ateroindex.df)

ateroindex.lme <- lme(log(ateroindex)~time, random=~1|pair_match/id, data=ateroindex.df, method='REML')
summary(ateroindex.lme)


### Triglycerides (mg/dL) ----
# Baseline
shapiro.test(log(konjac$triglycerides_t1))
fligner.test(log(konjac$triglycerides_t1) ~ konjac$treatment)
mt1 <- lm(log(triglycerides_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$triglycerides_t3))
fligner.test(log(konjac$triglycerides_t3) ~ konjac$treatment)
mt3 <- lm(log(triglycerides_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$triglycerides_delta)
fligner.test(konjac$triglycerides_delta ~ konjac$treatment)
mtd <- lm(triglycerides_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
triglycerides.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$triglycerides_t1, t3 = konjac$triglycerides_t3)
triglycerides.df <- triglycerides.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "triglycerides")
triglycerides.df <- na.omit(triglycerides.df)

triglycerides.lme <- lme(log(triglycerides)~treatment*time, random=~1|pair_match/id, data=triglycerides.df, method='REML')
summary(triglycerides.lme)
#random.effects(triglycerides.lme)
triglycerides.lsm <- emmeans(triglycerides.lme, ~treatment*time, type="response")
triglycerides.lsm

triglycerides.lme.plot1 <- ggplot(data = as.data.frame(triglycerides.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Triglycerides (mg/dL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

triglycerides.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$triglycerides_delta)
triglycerides.df <- na.omit(triglycerides.df)

triglycerides.lme <- lme(delta~treatment, random=~1|pair_match/id, data=triglycerides.df, method='REML')
summary(triglycerides.lme)
#random.effects(triglycerides.lme)
triglycerides.lsm <- emmeans(triglycerides.lme,  ~treatment)
triglycerides.lsm

triglycerides.lme.plot2 <- ggplot(data = as.data.frame(triglycerides.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change triglycerides (mg/dL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(triglycerides.lme.plot1, triglycerides.lme.plot2, rel_widths = c(2, 1))

# Control
triglycerides.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$triglycerides_t1, t3 = konjac_FI236$triglycerides_t3)
triglycerides.df <- triglycerides.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "triglycerides")
triglycerides.df <- na.omit(triglycerides.df)

triglycerides.lme <- lme(log(triglycerides)~time, random=~1|pair_match/id, data=triglycerides.df, method='REML')
summary(triglycerides.lme)

# Konjac
triglycerides.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$triglycerides_t1, t3 = konjac_FI418$triglycerides_t3)
triglycerides.df <- triglycerides.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "triglycerides")
triglycerides.df <- na.omit(triglycerides.df)

triglycerides.lme <- lme(log(triglycerides)~time, random=~1|pair_match/id, data=triglycerides.df, method='REML')
summary(triglycerides.lme)


# Glucose metabolism ----

### Fasting glycaemia (mg/dL) ----
# Baseline
shapiro.test(konjac$glycaemia_t1)
fligner.test(konjac$glycaemia_t1 ~ konjac$treatment)
mt1 <- lm(glycaemia_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(konjac$glycaemia_t3)
fligner.test(konjac$glycaemia_t3 ~ konjac$treatment)
mt3 <- lm(glycaemia_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$glycaemia_delta)
fligner.test(konjac$glycaemia_delta ~ konjac$treatment)
mtd <- lm(glycaemia_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
glycaemia.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$glycaemia_t1, t3 = konjac$glycaemia_t3)
glycaemia.df <- glycaemia.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "glycaemia")
glycaemia.df <- na.omit(glycaemia.df)

glycaemia.lme <- lme(glycaemia~treatment*time, random=~1|pair_match/id, data=glycaemia.df, method='REML')
summary(glycaemia.lme)
#random.effects(glycaemia.lme)
glycaemia.lsm <- emmeans(glycaemia.lme,  ~treatment*time)
glycaemia.lsm

glycaemia.lme.plot1 <- ggplot(data = as.data.frame(glycaemia.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Fasting glycaemia (mg/dL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

glycaemia.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$glycaemia_delta)
glycaemia.df <- na.omit(glycaemia.df)

glycaemia.lme <- lme(delta~treatment, random=~1|pair_match/id, data=glycaemia.df, method='REML')
summary(glycaemia.lme)
#random.effects(glycaemia.lme)
glycaemia.lsm <- emmeans(glycaemia.lme,  ~treatment)
glycaemia.lsm

glycaemia.lme.plot2 <- ggplot(data = as.data.frame(glycaemia.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change fasting glycaemia (mg/dL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(glycaemia.lme.plot1, glycaemia.lme.plot2, rel_widths = c(2, 1))

# Control
glycaemia.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$glycaemia_t1, t3 = konjac_FI236$glycaemia_t3)
glycaemia.df <- glycaemia.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "glycaemia")
glycaemia.df <- na.omit(glycaemia.df)

glycaemia.lme <- lme(glycaemia~time, random=~1|pair_match/id, data=glycaemia.df, method='REML')
summary(glycaemia.lme)

# Konjac
glycaemia.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$glycaemia_t1, t3 = konjac_FI418$glycaemia_t3)
glycaemia.df <- glycaemia.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "glycaemia")
glycaemia.df <- na.omit(glycaemia.df)

glycaemia.lme <- lme(glycaemia~time, random=~1|pair_match/id, data=glycaemia.df, method='REML')
summary(glycaemia.lme)


### Glycated hemoglobin A1c (%) ----
# Baseline
shapiro.test(log(konjac$HbA1c_t1))
fligner.test(log(konjac$HbA1c_t1) ~ konjac$treatment)
mt1 <- lm(log(HbA1c_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$HbA1c_t3))
fligner.test(log(konjac$HbA1c_t3) ~ konjac$treatment)
mt3 <- lm(log(HbA1c_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$HbA1c_delta)
fligner.test(konjac$HbA1c_delta ~ konjac$treatment)
mtd <- lm(HbA1c_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
HbA1c.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$HbA1c_t1, t3 = konjac$HbA1c_t3)
HbA1c.df <- HbA1c.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "HbA1c")
HbA1c.df <- na.omit(HbA1c.df)

HbA1c.lme <- lme(log(HbA1c)~treatment*time, random=~1|pair_match/id, data=HbA1c.df, method='REML')
summary(HbA1c.lme)
#random.effects(HbA1c.lme)
HbA1c.lsm <- emmeans(HbA1c.lme, ~treatment*time, type="response")
HbA1c.lsm

HbA1c.lme.plot1 <- ggplot(data = as.data.frame(HbA1c.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "HbA1c (%)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

HbA1c.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$HbA1c_delta)
HbA1c.df <- na.omit(HbA1c.df)

HbA1c.lme <- lme(delta~treatment, random=~1|pair_match/id, data=HbA1c.df, method='REML')
summary(HbA1c.lme)
#random.effects(HbA1c.lme)
HbA1c.lsm <- emmeans(HbA1c.lme,  ~treatment)
HbA1c.lsm

HbA1c.lme.plot2 <- ggplot(data = as.data.frame(HbA1c.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change HbA1c (%)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(HbA1c.lme.plot1, HbA1c.lme.plot2, rel_widths = c(2, 1))

# Control
HbA1c.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$HbA1c_t1, t3 = konjac_FI236$HbA1c_t3)
HbA1c.df <- HbA1c.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "HbA1c")
HbA1c.df <- na.omit(HbA1c.df)

HbA1c.lme <- lme(log(HbA1c)~time, random=~1|pair_match/id, data=HbA1c.df, method='REML')
summary(HbA1c.lme)

# Konjac
HbA1c.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$HbA1c_t1, t3 = konjac_FI418$HbA1c_t3)
HbA1c.df <- HbA1c.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "HbA1c")
HbA1c.df <- na.omit(HbA1c.df)

HbA1c.lme <- lme(log(HbA1c)~time, random=~1|pair_match/id, data=HbA1c.df, method='REML')
summary(HbA1c.lme)


### Fasting insulin (µUI/dL) ----
# Baseline
shapiro.test(log(konjac$insulin_t1))
fligner.test(log(konjac$insulin_t1) ~ konjac$treatment)
mt1 <- lm(log(insulin_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$insulin_t3))
fligner.test(log(konjac$insulin_t3) ~ konjac$treatment)
mt3 <- lm(log(insulin_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$insulin_delta)
fligner.test(konjac$insulin_delta ~ konjac$treatment)
mtd <- lm(insulin_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
insulin.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$insulin_t1, t3 = konjac$insulin_t3)
insulin.df <- insulin.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "insulin")
insulin.df <- na.omit(insulin.df)

insulin.lme <- lme(log(insulin)~treatment*time, random=~1|pair_match/id, data=insulin.df, method='REML')
summary(insulin.lme)
#random.effects(insulin.lme)
insulin.lsm <- emmeans(insulin.lme, ~treatment*time, type="response")
insulin.lsm

insulin.lme.plot1 <- ggplot(data = as.data.frame(insulin.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Fasting insulin (µUI/mL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

insulin.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$insulin_delta)
insulin.df <- na.omit(insulin.df)

insulin.lme <- lme(delta~treatment, random=~1|pair_match/id, data=insulin.df, method='REML')
summary(insulin.lme)
#random.effects(insulin.lme)
insulin.lsm <- emmeans(insulin.lme,  ~treatment)
insulin.lsm

insulin.lme.plot2 <- ggplot(data = as.data.frame(insulin.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change fasting insulin (µUI/mL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(insulin.lme.plot1, insulin.lme.plot2, rel_widths = c(2, 1))

# Control
insulin.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$insulin_t1, t3 = konjac_FI236$insulin_t3)
insulin.df <- insulin.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "insulin")
insulin.df <- na.omit(insulin.df)

insulin.lme <- lme(log(insulin)~time, random=~1|pair_match/id, data=insulin.df, method='REML')
summary(insulin.lme)

# Konjac
insulin.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$insulin_t1, t3 = konjac_FI418$insulin_t3)
insulin.df <- insulin.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "insulin")
insulin.df <- na.omit(insulin.df)

insulin.lme <- lme(log(insulin)~time, random=~1|pair_match/id, data=insulin.df, method='REML')
summary(insulin.lme)


### HOMA-IR (adimensional) ----
# Baseline
shapiro.test(log(konjac$homa_t1))
fligner.test(log(konjac$homa_t1) ~ konjac$treatment)
mt1 <- lm(log(homa_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$homa_t3))
fligner.test(log(konjac$homa_t3) ~ konjac$treatment)
mt3 <- lm(log(homa_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$homa_delta)
fligner.test(konjac$homa_delta ~ konjac$treatment)
mtd <- lm(homa_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
homa.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$homa_t1, t3 = konjac$homa_t3)
homa.df <- homa.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "homa")
homa.df <- na.omit(homa.df)

homa.lme <- lme(log(homa)~treatment*time, random=~1|pair_match/id, data=homa.df, method='REML')
summary(homa.lme)
#random.effects(homa.lme)
homa.lsm <- emmeans(homa.lme, ~treatment*time, type="response")
homa.lsm

homa.lme.plot1 <- ggplot(data = as.data.frame(homa.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "HOMA-IR") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

homa.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$homa_delta)
homa.df <- na.omit(homa.df)

homa.lme <- lme(delta~treatment, random=~1|pair_match/id, data=homa.df, method='REML')
summary(homa.lme)
#random.effects(homa.lme)
homa.lsm <- emmeans(homa.lme,  ~treatment)
homa.lsm

homa.lme.plot2 <- ggplot(data = as.data.frame(homa.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change HOMA-IR") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(homa.lme.plot1, homa.lme.plot2, rel_widths = c(2, 1))

# Control
homa.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$homa_t1, t3 = konjac_FI236$homa_t3)
homa.df <- homa.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "homa")
homa.df <- na.omit(homa.df)

homa.lme <- lme(log(homa)~time, random=~1|pair_match/id, data=homa.df, method='REML')
summary(homa.lme)

# Konjac
homa.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$homa_t1, t3 = konjac_FI418$homa_t3)
homa.df <- homa.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "homa")
homa.df <- na.omit(homa.df)

homa.lme <- lme(log(homa)~time, random=~1|pair_match/id, data=homa.df, method='REML')
summary(homa.lme)


# Blood pressure ----

### Systolic blood pressure (mm Hg) ----
# Baseline
b <- boxcox(lm(konjac$systolic_t1 ~ 1))
# Exact lambda
lambda <- b$x[which.max(b$y)]
lambda
shapiro.test(konjac$systolic_t1/2)
fligner.test(konjac$systolic_t1/2 ~ konjac$treatment)
mt1 <- lm(systolic_t1/2 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
b <- boxcox(lm(konjac$systolic_t3 ~ 1))
# Exact lambda
lambda <- b$x[which.max(b$y)]
lambda
shapiro.test(konjac$systolic_t3/2)
fligner.test(konjac$systolic_t3/2 ~ konjac$treatment)
mt3 <- lm(systolic_t3/2 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$systolic_delta)
fligner.test(konjac$systolic_delta ~ konjac$treatment)
mtd <- lm(systolic_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
systolic.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$systolic_t1, t3 = konjac$systolic_t3)
systolic.df <- systolic.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "systolic")
systolic.df <- na.omit(systolic.df)

systolic.lme <- lme(systolic/2~treatment*time, random=~1|pair_match/id, data=systolic.df, method='REML')
summary(systolic.lme)
#random.effects(systolic.lme)
systolic.lsm <- emmeans(systolic.lme, ~treatment*time)
systolic.lsm

systolic.lme.plot1 <- ggplot(data = as.data.frame(systolic.lsm), aes(x = time, y = emmean*2)) +
  geom_errorbar(aes(ymin = lower.CL*2, ymax = upper.CL*2), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Systolic blood pressure (mm Hg)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

systolic.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$systolic_delta)
systolic.df <- na.omit(systolic.df)

systolic.lme <- lme(delta~treatment, random=~1|pair_match/id, data=systolic.df, method='REML')
summary(systolic.lme)
#random.effects(systolic.lme)
systolic.lsm <- emmeans(systolic.lme,  ~treatment)
systolic.lsm

systolic.lme.plot2 <- ggplot(data = as.data.frame(systolic.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change systolic blood pressure (mm Hg)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(systolic.lme.plot1, systolic.lme.plot2, rel_widths = c(2, 1))

# Control
systolic.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$systolic_t1, t3 = konjac_FI236$systolic_t3)
systolic.df <- systolic.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "systolic")
systolic.df <- na.omit(systolic.df)

systolic.lme <- lme(log(systolic)~time, random=~1|pair_match/id, data=systolic.df, method='REML')
summary(systolic.lme)

# Konjac
systolic.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$systolic_t1, t3 = konjac_FI418$systolic_t3)
systolic.df <- systolic.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "systolic")
systolic.df <- na.omit(systolic.df)

systolic.lme <- lme(log(systolic)~time, random=~1|pair_match/id, data=systolic.df, method='REML')
summary(systolic.lme)


### Diastolic blood pressure (mm Hg) ----
# Baseline
shapiro.test(konjac$diastolic_t1)
fligner.test(konjac$diastolic_t1 ~ konjac$treatment)
mt1 <- lm(diastolic_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(konjac$diastolic_t3)
fligner.test(konjac$diastolic_t3 ~ konjac$treatment)
mt3 <- lm(diastolic_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$diastolic_delta)
fligner.test(konjac$diastolic_delta ~ konjac$treatment)
mtd <- lm(diastolic_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
diastolic.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$diastolic_t1, t3 = konjac$diastolic_t3)
diastolic.df <- diastolic.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "diastolic")
diastolic.df <- na.omit(diastolic.df)

diastolic.lme <- lme(diastolic~treatment*time, random=~1|pair_match/id, data=diastolic.df, method='REML')
summary(diastolic.lme)
#random.effects(diastolic.lme)
diastolic.lsm <- emmeans(diastolic.lme,  ~treatment*time)
diastolic.lsm

diastolic.lme.plot1 <- ggplot(data = as.data.frame(diastolic.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Diastolic blood pressure (mm Hg)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

diastolic.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$diastolic_delta)
diastolic.df <- na.omit(diastolic.df)

diastolic.lme <- lme(delta~treatment, random=~1|pair_match/id, data=diastolic.df, method='REML')
summary(diastolic.lme)
#random.effects(diastolic.lme)
diastolic.lsm <- emmeans(diastolic.lme,  ~treatment)
diastolic.lsm

diastolic.lme.plot2 <- ggplot(data = as.data.frame(diastolic.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change diastolic blood pressure (mm Hg)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(diastolic.lme.plot1, diastolic.lme.plot2, rel_widths = c(2, 1))

# Control
diastolic.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$diastolic_t1, t3 = konjac_FI236$diastolic_t3)
diastolic.df <- diastolic.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "diastolic")
diastolic.df <- na.omit(diastolic.df)

diastolic.lme <- lme(diastolic~time, random=~1|pair_match/id, data=diastolic.df, method='REML')
summary(diastolic.lme)

# Konjac
diastolic.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$diastolic_t1, t3 = konjac_FI418$diastolic_t3)
diastolic.df <- diastolic.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "diastolic")
diastolic.df <- na.omit(diastolic.df)

diastolic.lme <- lme(diastolic~time, random=~1|pair_match/id, data=diastolic.df, method='REML')
summary(diastolic.lme)


# Framingham score ----
# Baseline
shapiro.test(log(1-konjac$framingham_t1))
fligner.test(log(1-konjac$framingham_t1) ~ konjac$treatment)
mt1 <- lm(log(1-framingham_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(1-konjac$framingham_t3))
fligner.test(log(1-konjac$framingham_t3) ~ konjac$treatment)
mt3 <- lm(log(1-framingham_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$framingham_delta)
fligner.test(konjac$framingham_delta ~ konjac$treatment)
mtd <- lm(framingham_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
framingham.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$framingham_t1, t3 = konjac$framingham_t3)
framingham.df <- framingham.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "framingham")
framingham.df <- na.omit(framingham.df)

framingham.lme <- lme(log(1-framingham)~treatment*time, random=~1|pair_match/id, data=framingham.df, method='REML')
summary(framingham.lme)
#random.effects(framingham.lme)
framingham.lsm <- emmeans(framingham.lme, ~treatment*time) # 1-exp(x)
framingham.lsm

framingham.lme.plot1 <- ggplot(data = as.data.frame(framingham.lsm), aes(x = time, y = 1-exp(emmean))) +
  geom_errorbar(aes(ymin = 1-exp(lower.CL), ymax = 1-exp(upper.CL)), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Framingham score") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

framingham.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$framingham_delta)
framingham.df <- na.omit(framingham.df)

framingham.lme <- lme(delta~treatment, random=~1|pair_match/id, data=framingham.df, method='REML')
summary(framingham.lme)
#random.effects(framingham.lme)
framingham.lsm <- emmeans(framingham.lme,  ~treatment)
framingham.lsm

framingham.lme.plot2 <- ggplot(data = as.data.frame(framingham.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change Framingham score") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(framingham.lme.plot1, framingham.lme.plot2, rel_widths = c(2, 1))

# Control
framingham.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$framingham_t1, t3 = konjac_FI236$framingham_t3)
framingham.df <- framingham.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "framingham")
framingham.df <- na.omit(framingham.df)

framingham.lme <- lme(log(1-framingham)~time, random=~1|pair_match/id, data=framingham.df, method='REML')
summary(framingham.lme)

# Konjac
framingham.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$framingham_t1, t3 = konjac_FI418$framingham_t3)
framingham.df <- framingham.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "framingham")
framingham.df <- na.omit(framingham.df)

framingham.lme <- lme(log(1-framingham)~time, random=~1|pair_match/id, data=framingham.df, method='REML')
summary(framingham.lme)


# Inflammation, adipokines, and LBP ----

### High-sensitivity C reactive protein (mg/L) ----
# Baseline
shapiro.test(log(konjac$hsCRP_t1))
fligner.test(log(konjac$hsCRP_t1) ~ konjac$treatment)
mt1 <- lm(log(hsCRP_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$hsCRP_t3))
fligner.test(log(konjac$hsCRP_t3) ~ konjac$treatment)
mt3 <- lm(log(hsCRP_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$hsCRP_delta)
fligner.test(konjac$hsCRP_delta ~ konjac$treatment)
mtd <- lm(hsCRP_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
hsCRP.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$hsCRP_t1, t3 = konjac$hsCRP_t3)
hsCRP.df <- hsCRP.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "hsCRP")
hsCRP.df <- na.omit(hsCRP.df)

hsCRP.lme <- lme(log(hsCRP)~treatment*time, random=~1|pair_match/id, data=hsCRP.df, method='REML')
summary(hsCRP.lme)
#random.effects(hsCRP.lme)
hsCRP.lsm <- emmeans(hsCRP.lme, ~treatment*time, type="response")
hsCRP.lsm

hsCRP.lme.plot1 <- ggplot(data = as.data.frame(hsCRP.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "hs-CRP (mg/L)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

hsCRP.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$hsCRP_delta)
hsCRP.df <- na.omit(hsCRP.df)

hsCRP.lme <- lme(delta~treatment, random=~1|pair_match/id, data=hsCRP.df, method='REML')
summary(hsCRP.lme)
#random.effects(hsCRP.lme)
hsCRP.lsm <- emmeans(hsCRP.lme,  ~treatment)
hsCRP.lsm

hsCRP.lme.plot2 <- ggplot(data = as.data.frame(hsCRP.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change hs-CRP (mg/L)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(hsCRP.lme.plot1, hsCRP.lme.plot2, rel_widths = c(2, 1))

# Control
hsCRP.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$hsCRP_t1, t3 = konjac_FI236$hsCRP_t3)
hsCRP.df <- hsCRP.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "hsCRP")
hsCRP.df <- na.omit(hsCRP.df)

hsCRP.lme <- lme(log(hsCRP)~time, random=~1|pair_match/id, data=hsCRP.df, method='REML')
summary(hsCRP.lme)

# Konjac
hsCRP.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$hsCRP_t1, t3 = konjac_FI418$hsCRP_t3)
hsCRP.df <- hsCRP.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "hsCRP")
hsCRP.df <- na.omit(hsCRP.df)

hsCRP.lme <- lme(log(hsCRP)~time, random=~1|pair_match/id, data=hsCRP.df, method='REML')
summary(hsCRP.lme)


### IL-18 (pg/mL) ----
# Baseline
shapiro.test(log(konjac$IL_18_t1))
fligner.test(log(konjac$IL_18_t1) ~ konjac$treatment)
mt1 <- lm(log(IL_18_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$IL_18_t3))
fligner.test(log(konjac$IL_18_t3) ~ konjac$treatment)
mt3 <- lm(log(IL_18_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$IL_18_delta)
fligner.test(konjac$IL_18_delta ~ konjac$treatment)
mtd <- lm(IL_18_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
IL_18.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$IL_18_t1, t3 = konjac$IL_18_t3)
IL_18.df <- IL_18.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "IL_18")
IL_18.df <- na.omit(IL_18.df)

IL_18.lme <- lme(log(IL_18)~treatment*time, random=~1|pair_match/id, data=IL_18.df, method='REML')
summary(IL_18.lme)
#random.effects(IL_18.lme)
IL_18.lsm <- emmeans(IL_18.lme, ~treatment*time, type="response")
IL_18.lsm

IL_18.lme.plot1 <- ggplot(data = as.data.frame(IL_18.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "IL-18 (pg/mL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

IL_18.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$IL_18_delta)
IL_18.df <- na.omit(IL_18.df)

IL_18.lme <- lme(delta~treatment, random=~1|pair_match/id, data=IL_18.df, method='REML')
summary(IL_18.lme)
#random.effects(IL_18.lme)
IL_18.lsm <- emmeans(IL_18.lme,  ~treatment)
IL_18.lsm

IL_18.lme.plot2 <- ggplot(data = as.data.frame(IL_18.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change IL-18 (pg/mL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(IL_18.lme.plot1, IL_18.lme.plot2, rel_widths = c(2, 1))

# Control
IL_18.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$IL_18_t1, t3 = konjac_FI236$IL_18_t3)
IL_18.df <- IL_18.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "IL_18")
IL_18.df <- na.omit(IL_18.df)

IL_18.lme <- lme(log(IL_18)~time, random=~1|pair_match/id, data=IL_18.df, method='REML')
summary(IL_18.lme)

# Konjac
IL_18.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$IL_18_t1, t3 = konjac_FI418$IL_18_t3)
IL_18.df <- IL_18.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "IL_18")
IL_18.df <- na.omit(IL_18.df)

IL_18.lme <- lme(log(IL_18)~time, random=~1|pair_match/id, data=IL_18.df, method='REML')
summary(IL_18.lme)


### AgRP/ART (pg/mL) ----
# Baseline
shapiro.test(log(konjac$AgRP_ART_t1))
fligner.test(log(konjac$AgRP_ART_t1) ~ konjac$treatment)
mt1 <- lm(log(AgRP_ART_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$AgRP_ART_t3))
fligner.test(log(konjac$AgRP_ART_t3) ~ konjac$treatment)
mt3 <- lm(log(AgRP_ART_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$AgRP_ART_delta)
fligner.test(konjac$AgRP_ART_delta ~ konjac$treatment)
mtd <- lm(AgRP_ART_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
AgRP_ART.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$AgRP_ART_t1, t3 = konjac$AgRP_ART_t3)
AgRP_ART.df <- AgRP_ART.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "AgRP_ART")
AgRP_ART.df <- na.omit(AgRP_ART.df)

AgRP_ART.lme <- lme(log(AgRP_ART)~treatment*time, random=~1|pair_match/id, data=AgRP_ART.df, method='REML')
summary(AgRP_ART.lme)
#random.effects(AgRP_ART.lme)
AgRP_ART.lsm <- emmeans(AgRP_ART.lme, ~treatment*time, type="response")
AgRP_ART.lsm

AgRP_ART.lme.plot1 <- ggplot(data = as.data.frame(AgRP_ART.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "AgRP/ART (pg/mL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

AgRP_ART.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$AgRP_ART_delta)
AgRP_ART.df <- na.omit(AgRP_ART.df)

AgRP_ART.lme <- lme(delta~treatment, random=~1|pair_match/id, data=AgRP_ART.df, method='REML')
summary(AgRP_ART.lme)
#random.effects(AgRP_ART.lme)
AgRP_ART.lsm <- emmeans(AgRP_ART.lme,  ~treatment)
AgRP_ART.lsm

AgRP_ART.lme.plot2 <- ggplot(data = as.data.frame(AgRP_ART.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change AgRP/ART (pg/mL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(AgRP_ART.lme.plot1, AgRP_ART.lme.plot2, rel_widths = c(2, 1))

# Control
AgRP_ART.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$AgRP_ART_t1, t3 = konjac_FI236$AgRP_ART_t3)
AgRP_ART.df <- AgRP_ART.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "AgRP_ART")
AgRP_ART.df <- na.omit(AgRP_ART.df)

AgRP_ART.lme <- lme(log(AgRP_ART)~time, random=~1|pair_match/id, data=AgRP_ART.df, method='REML')
summary(AgRP_ART.lme)

# Konjac
AgRP_ART.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$AgRP_ART_t1, t3 = konjac_FI418$AgRP_ART_t3)
AgRP_ART.df <- AgRP_ART.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "AgRP_ART")
AgRP_ART.df <- na.omit(AgRP_ART.df)

AgRP_ART.lme <- lme(log(AgRP_ART)~time, random=~1|pair_match/id, data=AgRP_ART.df, method='REML')
summary(AgRP_ART.lme)


### Leptin (ng/mL) ----
# Baseline
shapiro.test(log(konjac$Leptin_t1))
fligner.test(log(konjac$Leptin_t1) ~ konjac$treatment)
mt1 <- lm(log(Leptin_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$Leptin_t3))
fligner.test(log(konjac$Leptin_t3) ~ konjac$treatment)
mt3 <- lm(log(Leptin_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$Leptin_delta)
fligner.test(konjac$Leptin_delta ~ konjac$treatment)
mtd <- lm(Leptin_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
Leptin.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$Leptin_t1, t3 = konjac$Leptin_t3)
Leptin.df <- Leptin.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "Leptin")
Leptin.df <- na.omit(Leptin.df)

Leptin.lme <- lme(log(Leptin)~treatment*time, random=~1|pair_match/id, data=Leptin.df, method='REML')
summary(Leptin.lme)
#random.effects(Leptin.lme)
Leptin.lsm <- emmeans(Leptin.lme, ~treatment*time, type="response")
Leptin.lsm

Leptin.lme.plot1 <- ggplot(data = as.data.frame(Leptin.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Leptin (ng/mL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

Leptin.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$Leptin_delta)
Leptin.df <- na.omit(Leptin.df)

Leptin.lme <- lme(delta~treatment, random=~1|pair_match/id, data=Leptin.df, method='REML')
summary(Leptin.lme)
#random.effects(Leptin.lme)
Leptin.lsm <- emmeans(Leptin.lme,  ~treatment)
Leptin.lsm

Leptin.lme.plot2 <- ggplot(data = as.data.frame(Leptin.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change leptin (ng/mL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(Leptin.lme.plot1, Leptin.lme.plot2, rel_widths = c(2, 1))

# Control
Leptin.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$Leptin_t1, t3 = konjac_FI236$Leptin_t3)
Leptin.df <- Leptin.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "Leptin")
Leptin.df <- na.omit(Leptin.df)

Leptin.lme <- lme(log(Leptin)~time, random=~1|pair_match/id, data=Leptin.df, method='REML')
summary(Leptin.lme)

# Konjac
Leptin.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$Leptin_t1, t3 = konjac_FI418$Leptin_t3)
Leptin.df <- Leptin.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "Leptin")
Leptin.df <- na.omit(Leptin.df)

Leptin.lme <- lme(log(Leptin)~time, random=~1|pair_match/id, data=Leptin.df, method='REML')
summary(Leptin.lme)


### Adiponectin (µg/mL) ----
# Baseline
shapiro.test(log(konjac$Adiponectin_t1))
fligner.test(log(konjac$Adiponectin_t1) ~ konjac$treatment)
mt1 <- lm(log(Adiponectin_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$Adiponectin_t3))
fligner.test(log(konjac$Adiponectin_t3) ~ konjac$treatment)
mt3 <- lm(log(Adiponectin_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$Adiponectin_delta)
fligner.test(konjac$Adiponectin_delta ~ konjac$treatment)
mtd <- lm(Adiponectin_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
Adiponectin.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$Adiponectin_t1, t3 = konjac$Adiponectin_t3)
Adiponectin.df <- Adiponectin.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "Adiponectin")
Adiponectin.df <- na.omit(Adiponectin.df)

Adiponectin.lme <- lme(log(Adiponectin)~treatment*time, random=~1|pair_match/id, data=Adiponectin.df, method='REML')
summary(Adiponectin.lme)
#random.effects(Adiponectin.lme)
Adiponectin.lsm <- emmeans(Adiponectin.lme, ~treatment*time, type="response")
Adiponectin.lsm

Adiponectin.lme.plot1 <- ggplot(data = as.data.frame(Adiponectin.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Adiponectin (µg/mL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

Adiponectin.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$Adiponectin_delta)
Adiponectin.df <- na.omit(Adiponectin.df)

Adiponectin.lme <- lme(delta~treatment, random=~1|pair_match/id, data=Adiponectin.df, method='REML')
summary(Adiponectin.lme)
#random.effects(Adiponectin.lme)
Adiponectin.lsm <- emmeans(Adiponectin.lme,  ~treatment)
Adiponectin.lsm

Adiponectin.lme.plot2 <- ggplot(data = as.data.frame(Adiponectin.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change adiponectin (µg/mL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(Adiponectin.lme.plot1, Adiponectin.lme.plot2, rel_widths = c(2, 1))

# Control
Adiponectin.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$Adiponectin_t1, t3 = konjac_FI236$Adiponectin_t3)
Adiponectin.df <- Adiponectin.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "Adiponectin")
Adiponectin.df <- na.omit(Adiponectin.df)

Adiponectin.lme <- lme(log(Adiponectin)~time, random=~1|pair_match/id, data=Adiponectin.df, method='REML')
summary(Adiponectin.lme)

# Konjac
Adiponectin.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$Adiponectin_t1, t3 = konjac_FI418$Adiponectin_t3)
Adiponectin.df <- Adiponectin.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "Adiponectin")
Adiponectin.df <- na.omit(Adiponectin.df)

Adiponectin.lme <- lme(log(Adiponectin)~time, random=~1|pair_match/id, data=Adiponectin.df, method='REML')
summary(Adiponectin.lme)


### Leptin/Adiponectin (adimensional) ----
# Baseline
shapiro.test(log(konjac$Leptin_Adiponectin_t1))
fligner.test(log(konjac$Leptin_Adiponectin_t1) ~ konjac$treatment)
mt1 <- lm(log(Leptin_Adiponectin_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$Leptin_Adiponectin_t3))
fligner.test(log(konjac$Leptin_Adiponectin_t3) ~ konjac$treatment)
mt3 <- lm(log(Leptin_Adiponectin_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$Leptin_Adiponectin_delta)
fligner.test(konjac$Leptin_Adiponectin_delta ~ konjac$treatment)
mtd <- lm(Leptin_Adiponectin_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
Leptin_Adiponectin.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$Leptin_Adiponectin_t1, t3 = konjac$Leptin_Adiponectin_t3)
Leptin_Adiponectin.df <- Leptin_Adiponectin.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "Leptin_Adiponectin")
Leptin_Adiponectin.df <- na.omit(Leptin_Adiponectin.df)

Leptin_Adiponectin.lme <- lme(log(Leptin_Adiponectin)~treatment*time, random=~1|pair_match/id, data=Leptin_Adiponectin.df, method='REML')
summary(Leptin_Adiponectin.lme)
#random.effects(Leptin_Adiponectin.lme)
Leptin_Adiponectin.lsm <- emmeans(Leptin_Adiponectin.lme, ~treatment*time, type="response")
Leptin_Adiponectin.lsm

Leptin_Adiponectin.lme.plot1 <- ggplot(data = as.data.frame(Leptin_Adiponectin.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Leptin/Adiponectin") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

Leptin_Adiponectin.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$Leptin_Adiponectin_delta)
Leptin_Adiponectin.df <- na.omit(Leptin_Adiponectin.df)

Leptin_Adiponectin.lme <- lme(delta~treatment, random=~1|pair_match/id, data=Leptin_Adiponectin.df, method='REML')
summary(Leptin_Adiponectin.lme)
#random.effects(Leptin_Adiponectin.lme)
Leptin_Adiponectin.lsm <- emmeans(Leptin_Adiponectin.lme,  ~treatment)
Leptin_Adiponectin.lsm

Leptin_Adiponectin.lme.plot2 <- ggplot(data = as.data.frame(Leptin_Adiponectin.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change Leptin/Adiponectin") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(Leptin_Adiponectin.lme.plot1, Leptin_Adiponectin.lme.plot2, rel_widths = c(2, 1))

# Control
Leptin_Adiponectin.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$Leptin_Adiponectin_t1, t3 = konjac_FI236$Leptin_Adiponectin_t3)
Leptin_Adiponectin.df <- Leptin_Adiponectin.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "Leptin_Adiponectin")
Leptin_Adiponectin.df <- na.omit(Leptin_Adiponectin.df)

Leptin_Adiponectin.lme <- lme(log(Leptin_Adiponectin)~time, random=~1|pair_match/id, data=Leptin_Adiponectin.df, method='REML')
summary(Leptin_Adiponectin.lme)

# Konjac
Leptin_Adiponectin.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$Leptin_Adiponectin_t1, t3 = konjac_FI418$Leptin_Adiponectin_t3)
Leptin_Adiponectin.df <- Leptin_Adiponectin.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "Leptin_Adiponectin")
Leptin_Adiponectin.df <- na.omit(Leptin_Adiponectin.df)

Leptin_Adiponectin.lme <- lme(log(Leptin_Adiponectin)~time, random=~1|pair_match/id, data=Leptin_Adiponectin.df, method='REML')
summary(Leptin_Adiponectin.lme)


### LBP (µg/mL) ----
# Baseline
shapiro.test(log(konjac$LBP_t1))
fligner.test(log(konjac$LBP_t1) ~ konjac$treatment)
mt1 <- lm(log(LBP_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$LBP_t3))
fligner.test(log(konjac$LBP_t3) ~ konjac$treatment)
mt3 <- lm(log(LBP_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$LBP_delta)
fligner.test(konjac$LBP_delta ~ konjac$treatment)
mtd <- lm(LBP_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
LBP.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$LBP_t1, t3 = konjac$LBP_t3)
LBP.df <- LBP.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "LBP")
LBP.df <- na.omit(LBP.df)

LBP.lme <- lme(log(LBP)~treatment*time, random=~1|pair_match/id, data=LBP.df, method='REML')
summary(LBP.lme)
#random.effects(LBP.lme)
LBP.lsm <- emmeans(LBP.lme, ~treatment*time, type="response")
LBP.lsm

LBP.lme.plot1 <- ggplot(data = as.data.frame(LBP.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "LBP (µg/mL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

LBP.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$LBP_delta)
LBP.df <- na.omit(LBP.df)

LBP.lme <- lme(delta~treatment, random=~1|pair_match/id, data=LBP.df, method='REML')
summary(LBP.lme)
#random.effects(LBP.lme)
LBP.lsm <- emmeans(LBP.lme,  ~treatment)
LBP.lsm

LBP.lme.plot2 <- ggplot(data = as.data.frame(LBP.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change LBP (µg/mL)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(LBP.lme.plot1, LBP.lme.plot2, rel_widths = c(2, 1))

# Control
LBP.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$LBP_t1, t3 = konjac_FI236$LBP_t3)
LBP.df <- LBP.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "LBP")
LBP.df <- na.omit(LBP.df)

LBP.lme <- lme(log(LBP)~time, random=~1|pair_match/id, data=LBP.df, method='REML')
summary(LBP.lme)

# Konjac
LBP.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$LBP_t1, t3 = konjac_FI418$LBP_t3)
LBP.df <- LBP.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "LBP")
LBP.df <- na.omit(LBP.df)

LBP.lme <- lme(log(LBP)~time, random=~1|pair_match/id, data=LBP.df, method='REML')
summary(LBP.lme)


# Fecal short-chain fatty acids (SCFAs) ----

### Acetate (µmol/g) ----
# Baseline
shapiro.test(log(konjac$acetic_t1))
fligner.test(log(konjac$acetic_t1) ~ konjac$treatment)
mt1 <- lm(log(acetic_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$acetic_t3))
fligner.test(log(konjac$acetic_t3) ~ konjac$treatment)
mt3 <- lm(log(acetic_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$acetic_delta)
fligner.test(konjac$acetic_delta ~ konjac$treatment)
mtd <- lm(acetic_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
acetic.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$acetic_t1, t3 = konjac$acetic_t3)
acetic.df <- acetic.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "acetic")
acetic.df <- na.omit(acetic.df)

acetic.lme <- lme(log(acetic)~treatment*time, random=~1|pair_match/id, data=acetic.df, method='REML')
summary(acetic.lme)
#random.effects(acetic.lme)
acetic.lsm <- emmeans(acetic.lme, ~treatment*time, type="response")
acetic.lsm

acetic.lme.plot1 <- ggplot(data = as.data.frame(acetic.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Fecal acetate (µmol/g)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

acetic.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$acetic_delta)
acetic.df <- na.omit(acetic.df)

acetic.lme <- lme(delta~treatment, random=~1|pair_match/id, data=acetic.df, method='REML')
summary(acetic.lme)
#random.effects(acetic.lme)
acetic.lsm <- emmeans(acetic.lme,  ~treatment)
acetic.lsm

acetic.lme.plot2 <- ggplot(data = as.data.frame(acetic.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change acetate (µmol/g)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(acetic.lme.plot1, acetic.lme.plot2, rel_widths = c(2, 1))

# Control
acetic.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$acetic_t1, t3 = konjac_FI236$acetic_t3)
acetic.df <- acetic.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "acetic")
acetic.df <- na.omit(acetic.df)

acetic.lme <- lme(log(acetic)~time, random=~1|pair_match/id, data=acetic.df, method='REML')
summary(acetic.lme)

# Konjac
acetic.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$acetic_t1, t3 = konjac_FI418$acetic_t3)
acetic.df <- acetic.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "acetic")
acetic.df <- na.omit(acetic.df)

acetic.lme <- lme(log(acetic)~time, random=~1|pair_match/id, data=acetic.df, method='REML')
summary(acetic.lme)


### Propionate (µmol/g) ----
# Baseline
shapiro.test(log(konjac$propionic_t1))
fligner.test(log(konjac$propionic_t1) ~ konjac$treatment)
mt1 <- lm(log(propionic_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$propionic_t3))
fligner.test(log(konjac$propionic_t3) ~ konjac$treatment)
mt3 <- lm(log(propionic_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$propionic_delta)
fligner.test(konjac$propionic_delta ~ konjac$treatment)
mtd <- lm(propionic_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
propionic.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$propionic_t1, t3 = konjac$propionic_t3)
propionic.df <- propionic.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "propionic")
propionic.df <- na.omit(propionic.df)

propionic.lme <- lme(log(propionic)~treatment*time, random=~1|pair_match/id, data=propionic.df, method='REML')
summary(propionic.lme)
#random.effects(propionic.lme)
propionic.lsm <- emmeans(propionic.lme, ~treatment*time, type="response")
propionic.lsm

propionic.lme.plot1 <- ggplot(data = as.data.frame(propionic.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Fecal propionate (µmol/g)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

propionic.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$propionic_delta)
propionic.df <- na.omit(propionic.df)

propionic.lme <- lme(delta~treatment, random=~1|pair_match/id, data=propionic.df, method='REML')
summary(propionic.lme)
#random.effects(propionic.lme)
propionic.lsm <- emmeans(propionic.lme,  ~treatment)
propionic.lsm

propionic.lme.plot2 <- ggplot(data = as.data.frame(propionic.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change propionate (µmol/g)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(propionic.lme.plot1, propionic.lme.plot2, rel_widths = c(2, 1))

# Control
propionic.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$propionic_t1, t3 = konjac_FI236$propionic_t3)
propionic.df <- propionic.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "propionic")
propionic.df <- na.omit(propionic.df)

propionic.lme <- lme(log(propionic)~time, random=~1|pair_match/id, data=propionic.df, method='REML')
summary(propionic.lme)

# Konjac
propionic.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$propionic_t1, t3 = konjac_FI418$propionic_t3)
propionic.df <- propionic.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "propionic")
propionic.df <- na.omit(propionic.df)

propionic.lme <- lme(log(propionic)~time, random=~1|pair_match/id, data=propionic.df, method='REML')
summary(propionic.lme)


### Butyrate (µmol/g) ----
# Baseline
shapiro.test(log(konjac$butyric_t1))
fligner.test(log(konjac$butyric_t1) ~ konjac$treatment)
mt1 <- lm(log(butyric_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$butyric_t3))
fligner.test(log(konjac$butyric_t3) ~ konjac$treatment)
mt3 <- lm(log(butyric_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$butyric_delta)
fligner.test(konjac$butyric_delta ~ konjac$treatment)
mtd <- lm(butyric_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
butyric.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$butyric_t1, t3 = konjac$butyric_t3)
butyric.df <- butyric.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "butyric")
butyric.df <- na.omit(butyric.df)

butyric.lme <- lme(log(butyric)~treatment*time, random=~1|pair_match/id, data=butyric.df, method='REML')
summary(butyric.lme)
#random.effects(butyric.lme)
butyric.lsm <- emmeans(butyric.lme, ~treatment*time, type="response")
butyric.lsm

butyric.lme.plot1 <- ggplot(data = as.data.frame(butyric.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Fecal butyrate (µmol/g)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

butyric.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$butyric_delta)
butyric.df <- na.omit(butyric.df)

butyric.lme <- lme(delta~treatment, random=~1|pair_match/id, data=butyric.df, method='REML')
summary(butyric.lme)
#random.effects(butyric.lme)
butyric.lsm <- emmeans(butyric.lme,  ~treatment)
butyric.lsm

butyric.lme.plot2 <- ggplot(data = as.data.frame(butyric.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change butyrate (µmol/g)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(butyric.lme.plot1, butyric.lme.plot2, rel_widths = c(2, 1))

# Control
butyric.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$butyric_t1, t3 = konjac_FI236$butyric_t3)
butyric.df <- butyric.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "butyric")
butyric.df <- na.omit(butyric.df)

butyric.lme <- lme(log(butyric)~time, random=~1|pair_match/id, data=butyric.df, method='REML')
summary(butyric.lme)

# Konjac
butyric.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$butyric_t1, t3 = konjac_FI418$butyric_t3)
butyric.df <- butyric.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "butyric")
butyric.df <- na.omit(butyric.df)

butyric.lme <- lme(log(butyric)~time, random=~1|pair_match/id, data=butyric.df, method='REML')
summary(butyric.lme)


### Isobutyrate (µmol/g) ----
# Baseline
shapiro.test(log(konjac$isobutyric_t1))
fligner.test(log(konjac$isobutyric_t1) ~ konjac$treatment)
mt1 <- lm(log(isobutyric_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(konjac$isobutyric_t3))
fligner.test(log(konjac$isobutyric_t3) ~ konjac$treatment)
mt3 <- lm(log(isobutyric_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$isobutyric_delta)
fligner.test(konjac$isobutyric_delta ~ konjac$treatment)
mtd <- lm(isobutyric_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
isobutyric.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$isobutyric_t1, t3 = konjac$isobutyric_t3)
isobutyric.df <- isobutyric.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "isobutyric")
isobutyric.df <- na.omit(isobutyric.df)

isobutyric.lme <- lme(log(isobutyric)~treatment*time, random=~1|pair_match/id, data=isobutyric.df, method='REML')
summary(isobutyric.lme)
#random.effects(isobutyric.lme)
isobutyric.lsm <- emmeans(isobutyric.lme, ~treatment*time, type="response")
isobutyric.lsm

isobutyric.lme.plot1 <- ggplot(data = as.data.frame(isobutyric.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Fecal isobutyrate (µmol/g)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

isobutyric.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$isobutyric_delta)
isobutyric.df <- na.omit(isobutyric.df)

isobutyric.lme <- lme(delta~treatment, random=~1|pair_match/id, data=isobutyric.df, method='REML')
summary(isobutyric.lme)
#random.effects(isobutyric.lme)
isobutyric.lsm <- emmeans(isobutyric.lme,  ~treatment)
isobutyric.lsm

isobutyric.lme.plot2 <- ggplot(data = as.data.frame(isobutyric.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change isobutyrate (µmol/g)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(isobutyric.lme.plot1, isobutyric.lme.plot2, rel_widths = c(2, 1))

# Control
isobutyric.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$isobutyric_t1, t3 = konjac_FI236$isobutyric_t3)
isobutyric.df <- isobutyric.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "isobutyric")
isobutyric.df <- na.omit(isobutyric.df)

isobutyric.lme <- lme(log(isobutyric)~time, random=~1|pair_match/id, data=isobutyric.df, method='REML')
summary(isobutyric.lme)

# Konjac
isobutyric.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$isobutyric_t1, t3 = konjac_FI418$isobutyric_t3)
isobutyric.df <- isobutyric.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "isobutyric")
isobutyric.df <- na.omit(isobutyric.df)

isobutyric.lme <- lme(log(isobutyric)~time, random=~1|pair_match/id, data=isobutyric.df, method='REML')
summary(isobutyric.lme)


### Valerate (µmol/g) ----
# Baseline
shapiro.test(log(0.001+konjac$valeric_t1))
fligner.test(log(0.001+konjac$valeric_t1) ~ konjac$treatment)
mt1 <- lm(log(0.001+konjac$valeric_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# End of intervention
shapiro.test(log(0.001+konjac$valeric_t3))
fligner.test(log(0.001+konjac$valeric_t3) ~ konjac$treatment)
mt3 <- lm(log(0.001+konjac$valeric_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change end - baseline
shapiro.test(konjac$valeric_delta)
fligner.test(konjac$valeric_delta ~ konjac$treatment)
mtd <- lm(valeric_delta ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect models (LME)
valeric.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$valeric_t1, t3 = konjac$valeric_t3)
valeric.df <- valeric.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "valeric")
valeric.df <- na.omit(valeric.df)

valeric.lme <- lme(log(0.001+valeric)~treatment*time, random=~1|pair_match/id, data=valeric.df, method='REML')
summary(valeric.lme)
#random.effects(valeric.lme)
valeric.lsm <- emmeans(valeric.lme,  ~treatment*time, type="response")
valeric.lsm

valeric.lme.plot1 <- ggplot(data = as.data.frame(valeric.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Fecal valerate (µmol/g)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

valeric.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$valeric_delta)
valeric.df <- na.omit(valeric.df)

valeric.lme <- lme(delta~treatment, random=~1|pair_match/id, data=valeric.df, method='REML')
summary(valeric.lme)
#random.effects(valeric.lme)
valeric.lsm <- emmeans(valeric.lme,  ~treatment)
valeric.lsm

valeric.lme.plot2 <- ggplot(data = as.data.frame(valeric.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change valerate (µmol/g)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(valeric.lme.plot1, valeric.lme.plot2, rel_widths = c(2, 1))

# Control
valeric.df <- data.frame(id = konjac_FI236$id, pair_match = konjac_FI236$pair_match, t1 = konjac_FI236$valeric_t1, t3 = konjac_FI236$valeric_t3)
valeric.df <- valeric.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "valeric")
valeric.df <- na.omit(valeric.df)

valeric.lme <- lme(log(0.001+valeric)~time, random=~1|pair_match/id, data=valeric.df, method='REML')
summary(valeric.lme)

# Konjac
valeric.df <- data.frame(id = konjac_FI418$id, pair_match = konjac_FI418$pair_match, t1 = konjac_FI418$valeric_t1, t3 = konjac_FI418$valeric_t3)
valeric.df <- valeric.df %>%
  pivot_longer(cols = c(-id, -pair_match), names_to = "time", values_to = "valeric")
valeric.df <- na.omit(valeric.df)

valeric.lme <- lme(log(0.001+valeric)~time, random=~1|pair_match/id, data=valeric.df, method='REML')
summary(valeric.lme)


# Physical activity ----

### Daily steps ----
shapiro.test(konjac$daily_steps)
fligner.test(konjac$daily_steps ~ konjac$treatment)
mt1 <- lm(daily_steps ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# Mixed-effect models (LME)
daily_steps.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, daily_steps = konjac$daily_steps)
daily_steps.df <- na.omit(daily_steps.df)

daily_steps.lme <- lme(daily_steps~treatment, random=~1|pair_match/id, data=daily_steps.df, method='REML')
summary(daily_steps.lme)
#random.effects(daily_steps.lme)
daily_steps.lsm <- emmeans(daily_steps.lme,  ~treatment)
daily_steps.lsm


# Intervention adherence ----
# Baseline
b <- boxcox(lm(konjac$adh_sachets ~ 1))
# Exact lambda
lambda <- b$x[which.max(b$y)]
lambda
shapiro.test(konjac$adh_sachets/2)
fligner.test(konjac$adh_sachets/2 ~ konjac$treatment)
mt1 <- lm(adh_sachets/2 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# Mixed-effect models (LME)
adh_sachets.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, adh_sachets = konjac$adh_sachets)
adh_sachets.df <- na.omit(adh_sachets.df)

adh_sachets.lme <- lme(adh_sachets/2~treatment, random=~1|pair_match/id, data=adh_sachets.df, method='REML')
summary(adh_sachets.lme)
#random.effects(adh_sachets.lme)
adh_sachets.lsm <- emmeans(adh_sachets.lme, ~treatment) # multiply by 2
adh_sachets.lsm



# Food intake ----

### Energy intake (kcal/day) ----
# Baseline
shapiro.test(konjac$KCAL_t1)
fligner.test(konjac$KCAL_t1 ~ konjac$treatment)
mt1 <- lm(KCAL_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

# Intermediate
shapiro.test(konjac$KCAL_t2)
fligner.test(konjac$KCAL_t2 ~ konjac$treatment)
mt2 <- lm(KCAL_t2 ~ treatment, data = konjac)
plot(fitted(mt2), resid(mt2))
abline(0,0) 
qqnorm(resid(mt2))
qqline(resid(mt2))

# End of intervention
shapiro.test(konjac$KCAL_t3)
fligner.test(konjac$KCAL_t3 ~ konjac$treatment)
mt3 <- lm(KCAL_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

# Change intermediate - baseline
shapiro.test(konjac$KCAL_deltat2)
fligner.test(konjac$KCAL_deltat2 ~ konjac$treatment)
mtd2 <- lm(KCAL_deltat2 ~ treatment, data = konjac)
plot(fitted(mtd2), resid(mtd2))
abline(0,0) 
qqnorm(resid(mtd2))
qqline(resid(mtd2))

# Change end - baseline
shapiro.test(konjac$KCAL_deltat3)
fligner.test(konjac$KCAL_deltat3 ~ konjac$treatment)
mtd3 <- lm(KCAL_deltat3 ~ treatment, data = konjac)
plot(fitted(mtd3), resid(mtd3))
abline(0,0) 
qqnorm(resid(mtd3))
qqline(resid(mtd3))

# Mixed-effect models (LME)
KCAL.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$KCAL_t1, t2 = konjac$KCAL_t2, t3 = konjac$KCAL_t3)
KCAL.df <- KCAL.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "KCAL")
KCAL.df <- na.omit(KCAL.df)

KCAL.lme <- lme(KCAL~treatment*time, random=~1|pair_match/id, data=KCAL.df, method='REML')
summary(KCAL.lme)
#random.effects(KCAL.lme)
KCAL.lsm <- emmeans(KCAL.lme,  ~treatment*time)
KCAL.lsm

KCAL.lme.plot1 <- ggplot(data = as.data.frame(KCAL.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Energy intake (Kcal/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1", "t2", "t3"),labels=c("Week 3", "Week 6", "Week 9"))

KCAL.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$KCAL_deltat3)
KCAL.df <- na.omit(KCAL.df)

KCAL.lme <- lme(delta~treatment, random=~1|pair_match/id, data=KCAL.df, method='REML')
summary(KCAL.lme)
#random.effects(KCAL.lme)
KCAL.lsm <- emmeans(KCAL.lme,  ~treatment)
KCAL.lsm

KCAL.lme.plot2 <- ggplot(data = as.data.frame(KCAL.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change energy intake (Kcal/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(KCAL.lme.plot1, KCAL.lme.plot2, rel_widths = c(2, 1))


### Normalized energy intake (kcal/day/kg) ----
shapiro.test(konjac$KCALperkg_t1)
fligner.test(konjac$KCALperkg_t1 ~ konjac$treatment)
mt1 <- lm(KCALperkg_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

shapiro.test(konjac$KCALperkg_t2)
fligner.test(konjac$KCALperkg_t2 ~ konjac$treatment)
mt2 <- lm(KCALperkg_t2 ~ treatment, data = konjac)
plot(fitted(mt2), resid(mt2))
abline(0,0) 
qqnorm(resid(mt2))
qqline(resid(mt2))

shapiro.test(konjac$KCALperkg_t3)
fligner.test(konjac$KCALperkg_t3 ~ konjac$treatment)
mt3 <- lm(KCALperkg_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

shapiro.test(konjac$KCALperkg_deltat2)
fligner.test(konjac$KCALperkg_deltat2 ~ konjac$treatment)
mtd2 <- lm(KCALperkg_deltat2 ~ treatment, data = konjac)
plot(fitted(mtd2), resid(mtd2))
abline(0,0) 
qqnorm(resid(mtd2))
qqline(resid(mtd2))

shapiro.test(konjac$KCALperkg_deltat3)
fligner.test(konjac$KCALperkg_deltat3 ~ konjac$treatment)
mtd3 <- lm(KCALperkg_deltat3 ~ treatment, data = konjac)
plot(fitted(mtd3), resid(mtd3))
abline(0,0) 
qqnorm(resid(mtd3))
qqline(resid(mtd3))

# Mixed-effect model
KCALperkg.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$KCALperkg_t1, t2 = konjac$KCALperkg_t2, t3 = konjac$KCALperkg_t3)
KCALperkg.df <- KCALperkg.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "KCALperkg")
KCALperkg.df <- na.omit(KCALperkg.df)

KCALperkg.lme <- lme(KCALperkg~treatment*time, random=~1|pair_match/id, data=KCALperkg.df, method='REML')
summary(KCALperkg.lme)
#random.effects(KCALperkg.lme)
KCALperkg.lsm <- emmeans(KCALperkg.lme,  ~treatment*time)
KCALperkg.lsm

KCALperkg.lme.plot1 <- ggplot(data = as.data.frame(KCALperkg.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Normalized energy\nintake (kcal/day/kg)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1", "t2", "t3"),labels=c("Week 3", "Week 6", "Week 9"))

KCALperkg.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$KCALperkg_deltat3)
KCALperkg.df <- na.omit(KCALperkg.df)

KCALperkg.lme <- lme(delta~treatment, random=~1|pair_match/id, data=KCALperkg.df, method='REML')
summary(KCALperkg.lme)
#random.effects(KCALperkg.lme)
KCALperkg.lsm <- emmeans(KCALperkg.lme,  ~treatment)
KCALperkg.lsm

KCALperkg.lme.plot2 <- ggplot(data = as.data.frame(KCALperkg.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change normalized energy\nintake (kcal/day/kg)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(KCALperkg.lme.plot1, KCALperkg.lme.plot2, rel_widths = c(2, 1))


### Carbohydrate intake (g/day) ----
shapiro.test(konjac$CARB_t1)
fligner.test(konjac$CARB_t1 ~ konjac$treatment)
mt1 <- lm(CARB_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

shapiro.test(konjac$CARB_t2)
fligner.test(konjac$CARB_t2 ~ konjac$treatment)
mt2 <- lm(CARB_t2 ~ treatment, data = konjac)
plot(fitted(mt2), resid(mt2))
abline(0,0) 
qqnorm(resid(mt2))
qqline(resid(mt2))

shapiro.test(konjac$CARB_t3)
fligner.test(konjac$CARB_t3 ~ konjac$treatment)
mt3 <- lm(CARB_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

shapiro.test(konjac$CARB_deltat2)
fligner.test(konjac$CARB_deltat2 ~ konjac$treatment)
mtd2 <- lm(CARB_deltat2 ~ treatment, data = konjac)
plot(fitted(mtd2), resid(mtd2))
abline(0,0) 
qqnorm(resid(mtd2))
qqline(resid(mtd2))

shapiro.test(konjac$CARB_deltat3)
fligner.test(konjac$CARB_deltat3 ~ konjac$treatment)
mtd3 <- lm(CARB_deltat3 ~ treatment, data = konjac)
plot(fitted(mtd3), resid(mtd3))
abline(0,0) 
qqnorm(resid(mtd3))
qqline(resid(mtd3))

# Mixed-effect model
CARB.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$CARB_t1, t2 = konjac$CARB_t2, t3 = konjac$CARB_t3)
CARB.df <- CARB.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "CARB")
CARB.df <- na.omit(CARB.df)

CARB.lme <- lme(CARB~treatment*time, random=~1|pair_match/id, data=CARB.df, method='REML')
summary(CARB.lme)
#random.effects(CARB.lme)
CARB.lsm <- emmeans(CARB.lme,  ~treatment*time)
CARB.lsm

CARB.lme.plot1 <- ggplot(data = as.data.frame(CARB.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Carbohydrate intake (g/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1", "t2", "t3"),labels=c("Week 3", "Week 6", "Week 9"))

CARB.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$CARB_deltat3)
CARB.df <- na.omit(CARB.df)

CARB.lme <- lme(delta~treatment, random=~1|pair_match/id, data=CARB.df, method='REML')
summary(CARB.lme)
#random.effects(CARB.lme)
CARB.lsm <- emmeans(CARB.lme,  ~treatment)
CARB.lsm

CARB.lme.plot2 <- ggplot(data = as.data.frame(CARB.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change carbohydrate intake (g/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(CARB.lme.plot1, CARB.lme.plot2, rel_widths = c(2, 1))


### Normalized carbohydrate intake (g/kg/day) ----
shapiro.test(konjac$CARBperkg_t1)
fligner.test(konjac$CARBperkg_t1 ~ konjac$treatment)
mt1 <- lm(CARBperkg_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

shapiro.test(konjac$CARBperkg_t2)
fligner.test(konjac$CARBperkg_t2 ~ konjac$treatment)
mt2 <- lm(CARBperkg_t2 ~ treatment, data = konjac)
plot(fitted(mt2), resid(mt2))
abline(0,0) 
qqnorm(resid(mt2))
qqline(resid(mt2))

shapiro.test(konjac$CARBperkg_t3)
fligner.test(konjac$CARBperkg_t3 ~ konjac$treatment)
mt3 <- lm(CARBperkg_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

shapiro.test(konjac$CARBperkg_deltat2)
fligner.test(konjac$CARBperkg_deltat2 ~ konjac$treatment)
mtd2 <- lm(CARBperkg_deltat2 ~ treatment, data = konjac)
plot(fitted(mtd2), resid(mtd2))
abline(0,0) 
qqnorm(resid(mtd2))
qqline(resid(mtd2))

shapiro.test(konjac$CARBperkg_deltat3)
fligner.test(konjac$CARBperkg_deltat3 ~ konjac$treatment)
mtd3 <- lm(CARBperkg_deltat3 ~ treatment, data = konjac)
plot(fitted(mtd3), resid(mtd3))
abline(0,0) 
qqnorm(resid(mtd3))
qqline(resid(mtd3))

# Mixed-effect model
CARBperkg.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$CARBperkg_t1, t2 = konjac$CARBperkg_t2, t3 = konjac$CARBperkg_t3)
CARBperkg.df <- CARBperkg.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "CARBperkg")
CARBperkg.df <- na.omit(CARBperkg.df)

CARBperkg.lme <- lme(CARBperkg~treatment*time, random=~1|pair_match/id, data=CARBperkg.df, method='REML')
summary(CARBperkg.lme)
#random.effects(CARBperkg.lme)
CARBperkg.lsm <- emmeans(CARBperkg.lme,  ~treatment*time)
CARBperkg.lsm

CARBperkg.lme.plot1 <- ggplot(data = as.data.frame(CARBperkg.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Normalized carbohydrate\nintake (g/kg/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1", "t2", "t3"),labels=c("Week 3", "Week 6", "Week 9"))

CARBperkg.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$CARBperkg_deltat3)
CARBperkg.df <- na.omit(CARBperkg.df)

CARBperkg.lme <- lme(delta~treatment, random=~1|pair_match/id, data=CARBperkg.df, method='REML')
summary(CARBperkg.lme)
#random.effects(CARBperkg.lme)
CARBperkg.lsm <- emmeans(CARBperkg.lme,  ~treatment)
CARBperkg.lsm

CARBperkg.lme.plot2 <- ggplot(data = as.data.frame(CARBperkg.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change normalized carbohydrate\nintake (g/kg/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(CARBperkg.lme.plot1, CARBperkg.lme.plot2, rel_widths = c(2, 1))


### Carbohydrate intake (% of total energy) ----
shapiro.test(konjac$CARBperc_t1)
fligner.test(konjac$CARBperc_t1 ~ konjac$treatment)
mt1 <- lm(CARBperc_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

shapiro.test(konjac$CARBperc_t2)
fligner.test(konjac$CARBperc_t2 ~ konjac$treatment)
mt2 <- lm(CARBperc_t2 ~ treatment, data = konjac)
plot(fitted(mt2), resid(mt2))
abline(0,0) 
qqnorm(resid(mt2))
qqline(resid(mt2))

shapiro.test(konjac$CARBperc_t3)
fligner.test(konjac$CARBperc_t3 ~ konjac$treatment)
mt3 <- lm(CARBperc_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

shapiro.test(konjac$CARBperc_deltat2)
fligner.test(konjac$CARBperc_deltat2 ~ konjac$treatment)
mtd2 <- lm(CARBperc_deltat2 ~ treatment, data = konjac)
plot(fitted(mtd2), resid(mtd2))
abline(0,0) 
qqnorm(resid(mtd2))
qqline(resid(mtd2))

shapiro.test(konjac$CARBperc_deltat3)
fligner.test(konjac$CARBperc_deltat3 ~ konjac$treatment)
mtd3 <- lm(CARBperc_deltat3 ~ treatment, data = konjac)
plot(fitted(mtd3), resid(mtd3))
abline(0,0) 
qqnorm(resid(mtd3))
qqline(resid(mtd3))

# Mixed-effect model
CARBperc.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$CARBperc_t1, t2 = konjac$CARBperc_t2, t3 = konjac$CARBperc_t3)
CARBperc.df <- CARBperc.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "CARBperc")
CARBperc.df <- na.omit(CARBperc.df)

CARBperc.lme <- lme(CARBperc~treatment*time, random=~1|pair_match/id, data=CARBperc.df, method='REML')
summary(CARBperc.lme)
#random.effects(CARBperc.lme)
CARBperc.lsm <- emmeans(CARBperc.lme,  ~treatment*time)
CARBperc.lsm

CARBperc.lme.plot1 <- ggplot(data = as.data.frame(CARBperc.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Carbohydrate intake (% of energy)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1", "t2", "t3"),labels=c("week 3", "Week 6", "Week 9"))

CARBperc.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$CARBperc_deltat3)
CARBperc.df <- na.omit(CARBperc.df)

CARBperc.lme <- lme(delta~treatment, random=~1|pair_match/id, data=CARBperc.df, method='REML')
summary(CARBperc.lme)
#random.effects(CARBperc.lme)
CARBperc.lsm <- emmeans(CARBperc.lme,  ~treatment)
CARBperc.lsm

CARBperc.lme.plot2 <- ggplot(data = as.data.frame(CARBperc.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change carbohydrate intake (% of energy)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(CARBperc.lme.plot1, CARBperc.lme.plot2, rel_widths = c(2, 1))


### Sugar intake (g/day) ----
shapiro.test(log(konjac$SUGR_t1))
fligner.test(log(konjac$SUGR_t1) ~ konjac$treatment)
mt1 <- lm(log(SUGR_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

shapiro.test(log(konjac$SUGR_t2))
fligner.test(log(konjac$SUGR_t2) ~ konjac$treatment)
mt2 <- lm(log(SUGR_t2) ~ treatment, data = konjac)
plot(fitted(mt2), resid(mt2))
abline(0,0) 
qqnorm(resid(mt2))
qqline(resid(mt2))

shapiro.test(log(konjac$SUGR_t3))
fligner.test(log(konjac$SUGR_t3) ~ konjac$treatment)
mt3 <- lm(log(SUGR_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

shapiro.test(konjac$SUGR_deltat2)
fligner.test(konjac$SUGR_deltat2 ~ konjac$treatment)
mtd2 <- lm(SUGR_deltat2 ~ treatment, data = konjac)
plot(fitted(mtd2), resid(mtd2))
abline(0,0) 
qqnorm(resid(mtd2))
qqline(resid(mtd2))

shapiro.test(konjac$SUGR_deltat3)
fligner.test(konjac$SUGR_deltat3 ~ konjac$treatment)
mtd3 <- lm(SUGR_deltat3 ~ treatment, data = konjac)
plot(fitted(mtd3), resid(mtd3))
abline(0,0) 
qqnorm(resid(mtd3))
qqline(resid(mtd3))

# Mixed-effect model
SUGR.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$SUGR_t1, t2 = konjac$SUGR_t2, t3 = konjac$SUGR_t3)
SUGR.df <- SUGR.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "SUGR")
SUGR.df <- na.omit(SUGR.df)

SUGR.lme <- lme(log(SUGR)~treatment*time, random=~1|pair_match/id, data=SUGR.df, method='REML')
summary(SUGR.lme)
#random.effects(SUGR.lme)
SUGR.lsm <- emmeans(SUGR.lme, ~treatment*time, type="response")
SUGR.lsm

SUGR.lme.plot1 <- ggplot(data = as.data.frame(SUGR.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Sugar intake (g/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1", "t2", "t3"),labels=c("Week 3", "Week 6", "Week 9"))

SUGR.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$SUGR_deltat3)
SUGR.df <- na.omit(SUGR.df)

SUGR.lme <- lme(delta~treatment, random=~1|pair_match/id, data=SUGR.df, method='REML')
summary(SUGR.lme)
#random.effects(SUGR.lme)
SUGR.lsm <- emmeans(SUGR.lme,  ~treatment)
SUGR.lsm

SUGR.lme.plot2 <- ggplot(data = as.data.frame(SUGR.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change sugar intake (g/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(SUGR.lme.plot1, SUGR.lme.plot2, rel_widths = c(2, 1))


### Normalized sugar intake (g/kg/day) ----
shapiro.test(log(konjac$SUGRperkg_t1))
fligner.test(log(konjac$SUGRperkg_t1) ~ konjac$treatment)
mt1 <- lm(log(SUGRperkg_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

shapiro.test(log(konjac$SUGRperkg_t2))
fligner.test(log(konjac$SUGRperkg_t2) ~ konjac$treatment)
mt2 <- lm(log(SUGRperkg_t2) ~ treatment, data = konjac)
plot(fitted(mt2), resid(mt2))
abline(0,0) 
qqnorm(resid(mt2))
qqline(resid(mt2))

shapiro.test(log(konjac$SUGRperkg_t3))
fligner.test(log(konjac$SUGRperkg_t3) ~ konjac$treatment)
mt3 <- lm(log(SUGRperkg_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

shapiro.test(konjac$SUGRperkg_deltat2)
fligner.test(konjac$SUGRperkg_deltat2 ~ konjac$treatment)
mtd2 <- lm(SUGRperkg_deltat2 ~ treatment, data = konjac)
plot(fitted(mtd2), resid(mtd2))
abline(0,0) 
qqnorm(resid(mtd2))
qqline(resid(mtd2))

shapiro.test(konjac$SUGRperkg_deltat3)
fligner.test(konjac$SUGRperkg_deltat3 ~ konjac$treatment)
mtd3 <- lm(SUGRperkg_deltat3 ~ treatment, data = konjac)
plot(fitted(mtd3), resid(mtd3))
abline(0,0) 
qqnorm(resid(mtd3))
qqline(resid(mtd3))

# Mixed-effect model
SUGRperkg.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$SUGRperkg_t1, t2 = konjac$SUGRperkg_t2, t3 = konjac$SUGRperkg_t3)
SUGRperkg.df <- SUGRperkg.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "SUGRperkg")
SUGRperkg.df <- na.omit(SUGRperkg.df)

SUGRperkg.lme <- lme(log(SUGRperkg)~treatment*time, random=~1|pair_match/id, data=SUGRperkg.df, method='REML')
summary(SUGRperkg.lme)
#random.effects(SUGRperkg.lme)
SUGRperkg.lsm <- emmeans(SUGRperkg.lme, ~treatment*time, type="response")
SUGRperkg.lsm

SUGRperkg.lme.plot1 <- ggplot(data = as.data.frame(SUGRperkg.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Normalized sugar\nintake (g/kg/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1", "t2", "t3"),labels=c("Week 3", "Week 6", "Week 9"))

SUGRperkg.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$SUGRperkg_deltat3)
SUGRperkg.df <- na.omit(SUGRperkg.df)

SUGRperkg.lme <- lme(delta~treatment, random=~1|pair_match/id, data=SUGRperkg.df, method='REML')
summary(SUGRperkg.lme)
#random.effects(SUGRperkg.lme)
SUGRperkg.lsm <- emmeans(SUGRperkg.lme,  ~treatment)
SUGRperkg.lsm

SUGRperkg.lme.plot2 <- ggplot(data = as.data.frame(SUGRperkg.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change normalized sugar\nintake (g/kg/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(SUGRperkg.lme.plot1, SUGRperkg.lme.plot2, rel_widths = c(2, 1))


### Protein intake (g/day) ----
shapiro.test(konjac$PROT_t1)
fligner.test(konjac$PROT_t1 ~ konjac$treatment)
mt1 <- lm(PROT_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

shapiro.test(konjac$PROT_t2)
fligner.test(konjac$PROT_t2 ~ konjac$treatment)
mt2 <- lm(PROT_t2 ~ treatment, data = konjac)
plot(fitted(mt2), resid(mt2))
abline(0,0) 
qqnorm(resid(mt2))
qqline(resid(mt2))

shapiro.test(konjac$PROT_t3)
fligner.test(konjac$PROT_t3 ~ konjac$treatment)
mt3 <- lm(PROT_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

shapiro.test(konjac$PROT_deltat2)
fligner.test(konjac$PROT_deltat2 ~ konjac$treatment)
mtd <- lm(PROT_deltat2 ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

shapiro.test(konjac$PROT_deltat3)
fligner.test(konjac$PROT_deltat3 ~ konjac$treatment)
mtd <- lm(PROT_deltat3 ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect model
PROT.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$PROT_t1, t2 = konjac$PROT_t2, t3 = konjac$PROT_t3)
PROT.df <- PROT.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "PROT")
PROT.df <- na.omit(PROT.df)

PROT.lme <- lme(PROT~treatment*time, random=~1|pair_match/id, data=PROT.df, method='REML')
summary(PROT.lme)
#random.effects(PROT.lme)
PROT.lsm <- emmeans(PROT.lme,  ~treatment*time)
PROT.lsm

PROT.lme.plot1 <- ggplot(data = as.data.frame(PROT.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Protein intake (g/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1", "t2", "t3"),labels=c("Week 3", "Week 6", "Week 9"))

PROT.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$PROT_deltat3)
PROT.df <- na.omit(PROT.df)

PROT.lme <- lme(delta~treatment, random=~1|pair_match/id, data=PROT.df, method='REML')
summary(PROT.lme)
#random.effects(PROT.lme)
PROT.lsm <- emmeans(PROT.lme,  ~treatment)
PROT.lsm

PROT.lme.plot2 <- ggplot(data = as.data.frame(PROT.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change protein intake (g/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(PROT.lme.plot1, PROT.lme.plot2, rel_widths = c(2, 1))


### Normalized protein intake (g/kg/day) ----
shapiro.test(konjac$PROTperkg_t1)
fligner.test(konjac$PROTperkg_t1 ~ konjac$treatment)
mt1 <- lm(PROTperkg_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

shapiro.test(konjac$PROTperkg_t2)
fligner.test(konjac$PROTperkg_t2 ~ konjac$treatment)
mt2 <- lm(PROTperkg_t2 ~ treatment, data = konjac)
plot(fitted(mt2), resid(mt2))
abline(0,0) 
qqnorm(resid(mt2))
qqline(resid(mt2))

shapiro.test(konjac$PROTperkg_t3)
fligner.test(konjac$PROTperkg_t3 ~ konjac$treatment)
mt3 <- lm(PROTperkg_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

shapiro.test(konjac$PROTperkg_deltat2)
fligner.test(konjac$PROTperkg_deltat2 ~ konjac$treatment)
mtd <- lm(PROTperkg_deltat2 ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

shapiro.test(konjac$PROTperkg_deltat3)
fligner.test(konjac$PROTperkg_deltat3 ~ konjac$treatment)
mtd <- lm(PROTperkg_deltat3 ~ treatment, data = konjac)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect model
PROTperkg.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$PROTperkg_t1, t2 = konjac$PROTperkg_t2, t3 = konjac$PROTperkg_t3)
PROTperkg.df <- PROTperkg.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "PROTperkg")
PROTperkg.df <- na.omit(PROTperkg.df)

PROTperkg.lme <- lme(PROTperkg~treatment*time, random=~1|pair_match/id, data=PROTperkg.df, method='REML')
summary(PROTperkg.lme)
#random.effects(PROTperkg.lme)
PROTperkg.lsm <- emmeans(PROTperkg.lme,  ~treatment*time)
PROTperkg.lsm

PROTperkg.lme.plot1 <- ggplot(data = as.data.frame(PROTperkg.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Normalized protein\nintake (g/kg/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1", "t2", "t3"),labels=c("Week 3", "Week 6", "Week 9"))

PROTperkg.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$PROTperkg_deltat3)
PROTperkg.df <- na.omit(PROTperkg.df)

PROTperkg.lme <- lme(delta~treatment, random=~1|pair_match/id, data=PROTperkg.df, method='REML')
summary(PROTperkg.lme)
#random.effects(PROTperkg.lme)
PROTperkg.lsm <- emmeans(PROTperkg.lme,  ~treatment)
PROTperkg.lsm

PROTperkg.lme.plot2 <- ggplot(data = as.data.frame(PROTperkg.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change normalized protein\nintake (g/kg/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(PROTperkg.lme.plot1, PROTperkg.lme.plot2, rel_widths = c(2, 1))


### Protein intake (% of total energy) ----
shapiro.test(konjac$PROTperc_t1)
fligner.test(konjac$PROTperc_t1 ~ konjac$treatment)
mt1 <- lm(PROTperc_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

shapiro.test(konjac$PROTperc_t2)
fligner.test(konjac$PROTperc_t2 ~ konjac$treatment)
mt2 <- lm(PROTperc_t2 ~ treatment, data = konjac)
plot(fitted(mt2), resid(mt2))
abline(0,0) 
qqnorm(resid(mt2))
qqline(resid(mt2))

shapiro.test(konjac$PROTperc_t3)
fligner.test(konjac$PROTperc_t3 ~ konjac$treatment)
mt3 <- lm(PROTperc_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

shapiro.test(konjac$PROTperc_deltat2)
fligner.test(konjac$PROTperc_deltat2 ~ konjac$treatment)
mtd2 <- lm(PROTperc_deltat2 ~ treatment, data = konjac)
plot(fitted(mtd2), resid(mtd2))
abline(0,0) 
qqnorm(resid(mtd2))
qqline(resid(mtd2))

shapiro.test(konjac$PROTperc_deltat3)
fligner.test(konjac$PROTperc_deltat3 ~ konjac$treatment)
mtd3 <- lm(PROTperc_deltat3 ~ treatment, data = konjac)
plot(fitted(mtd3), resid(mtd3))
abline(0,0) 
qqnorm(resid(mtd3))
qqline(resid(mtd3))

# Mixed-effect model
PROTperc.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$PROTperc_t1, t2 = konjac$PROTperc_t2, t3 = konjac$PROTperc_t3)
PROTperc.df <- PROTperc.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "PROTperc")
PROTperc.df <- na.omit(PROTperc.df)

PROTperc.lme <- lme(PROTperc~treatment*time, random=~1|pair_match/id, data=PROTperc.df, method='REML')
summary(PROTperc.lme)
#random.effects(PROTperc.lme)
PROTperc.lsm <- emmeans(PROTperc.lme,  ~treatment*time)
PROTperc.lsm

PROTperc.lme.plot1 <- ggplot(data = as.data.frame(PROTperc.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Protein intake (% of energy)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1", "t2", "t3"),labels=c("Week 3", "Week 6", "Week 9"))

PROTperc.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$PROTperc_deltat3)
PROTperc.df <- na.omit(PROTperc.df)

PROTperc.lme <- lme(delta~treatment, random=~1|pair_match/id, data=PROTperc.df, method='REML')
summary(PROTperc.lme)
#random.effects(PROTperc.lme)
PROTperc.lsm <- emmeans(PROTperc.lme,  ~treatment)
PROTperc.lsm

PROTperc.lme.plot2 <- ggplot(data = as.data.frame(PROTperc.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change protein intake (% of energy)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(PROTperc.lme.plot1, PROTperc.lme.plot2, rel_widths = c(2, 1))


### Total fat intake (g/day) ----
shapiro.test(log(konjac$TFAT_t1))
fligner.test(log(konjac$TFAT_t1) ~ konjac$treatment)
mt1 <- lm(log(TFAT_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

shapiro.test(log(konjac$TFAT_t2))
fligner.test(log(konjac$TFAT_t2) ~ konjac$treatment)
mt2 <- lm(log(TFAT_t2) ~ treatment, data = konjac)
plot(fitted(mt2), resid(mt2))
abline(0,0) 
qqnorm(resid(mt2))
qqline(resid(mt2))

shapiro.test(log(konjac$TFAT_t3))
fligner.test(log(konjac$TFAT_t3) ~ konjac$treatment)
mt3 <- lm(log(TFAT_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

shapiro.test(konjac$TFAT_deltat2)
fligner.test(konjac$TFAT_deltat2 ~ konjac$treatment)
mtd2 <- lm(TFAT_deltat2 ~ treatment, data = konjac)
plot(fitted(mtd2), resid(mtd2))
abline(0,0) 
qqnorm(resid(mtd2))
qqline(resid(mtd2))

shapiro.test(konjac$TFAT_deltat3)
fligner.test(konjac$TFAT_deltat3 ~ konjac$treatment)
mtd3 <- lm(TFAT_deltat3 ~ treatment, data = konjac)
plot(fitted(mtd3), resid(mtd3))
abline(0,0) 
qqnorm(resid(mtd3))
qqline(resid(mtd3))

# Mixed-effect model
TFAT.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$TFAT_t1, t2 = konjac$TFAT_t2, t3 = konjac$TFAT_t3)
TFAT.df <- TFAT.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "TFAT")
TFAT.df <- na.omit(TFAT.df)

TFAT.lme <- lme(log(TFAT)~treatment*time, random=~1|pair_match/id, data=TFAT.df, method='REML')
summary(TFAT.lme)
#random.effects(TFAT.lme)
TFAT.lsm <- emmeans(TFAT.lme, ~treatment*time, type="response")
TFAT.lsm

TFAT.lme.plot1 <- ggplot(data = as.data.frame(TFAT.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Total fat intake (g/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1", "t2", "t3"),labels=c("Week 3", "Week 6", "Week 9"))

TFAT.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$TFAT_deltat3)
TFAT.df <- na.omit(TFAT.df)

TFAT.lme <- lme(delta~treatment, random=~1|pair_match/id, data=TFAT.df, method='REML')
summary(TFAT.lme)
#random.effects(TFAT.lme)
TFAT.lsm <- emmeans(TFAT.lme,  ~treatment)
TFAT.lsm

TFAT.lme.plot2 <- ggplot(data = as.data.frame(TFAT.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change total fat intake (g/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(TFAT.lme.plot1, TFAT.lme.plot2, rel_widths = c(2, 1))


### Normalized total fat intake (g/kg/day) ----
shapiro.test(log(konjac$TFATperkg_t1))
fligner.test(log(konjac$TFATperkg_t1) ~ konjac$treatment)
mt1 <- lm(log(TFATperkg_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

shapiro.test(log(konjac$TFATperkg_t2))
fligner.test(log(konjac$TFATperkg_t2) ~ konjac$treatment)
mt2 <- lm(log(TFATperkg_t2) ~ treatment, data = konjac)
plot(fitted(mt2), resid(mt2))
abline(0,0) 
qqnorm(resid(mt2))
qqline(resid(mt2))

shapiro.test(log(konjac$TFATperkg_t3))
fligner.test(log(konjac$TFATperkg_t3) ~ konjac$treatment)
mt3 <- lm(log(TFATperkg_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

shapiro.test(konjac$TFATperkg_deltat2)
fligner.test(konjac$TFATperkg_deltat2 ~ konjac$treatment)
mtd2 <- lm(TFATperkg_deltat2 ~ treatment, data = konjac)
plot(fitted(mtd2), resid(mtd2))
abline(0,0) 
qqnorm(resid(mtd2))
qqline(resid(mtd2))

shapiro.test(konjac$TFATperkg_deltat3)
fligner.test(konjac$TFATperkg_deltat3 ~ konjac$treatment)
mtd3 <- lm(TFATperkg_deltat3 ~ treatment, data = konjac)
plot(fitted(mtd3), resid(mtd3))
abline(0,0) 
qqnorm(resid(mtd3))
qqline(resid(mtd3))

# Mixed-effect model
TFATperkg.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$TFATperkg_t1, t2 = konjac$TFATperkg_t2, t3 = konjac$TFATperkg_t3)
TFATperkg.df <- TFATperkg.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "TFATperkg")
TFATperkg.df <- na.omit(TFATperkg.df)

TFATperkg.lme <- lme(log(TFATperkg)~treatment*time, random=~1|pair_match/id, data=TFATperkg.df, method='REML')
summary(TFATperkg.lme)
#random.effects(TFATperkg.lme)
TFATperkg.lsm <- emmeans(TFATperkg.lme, ~treatment*time, type="response")
TFATperkg.lsm

TFATperkg.lme.plot1 <- ggplot(data = as.data.frame(TFATperkg.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Normalized total fat\nintake (g/kg/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1", "t2", "t3"),labels=c("Week 3", "Week 6", "Week 9"))

TFATperkg.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$TFATperkg_deltat3)
TFATperkg.df <- na.omit(TFATperkg.df)

TFATperkg.lme <- lme(delta~treatment, random=~1|pair_match/id, data=TFATperkg.df, method='REML')
summary(TFATperkg.lme)
#random.effects(TFATperkg.lme)
TFATperkg.lsm <- emmeans(TFATperkg.lme,  ~treatment)
TFATperkg.lsm

TFATperkg.lme.plot2 <- ggplot(data = as.data.frame(TFATperkg.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change normalized total fat\nintake (g/kg/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(TFATperkg.lme.plot1, TFATperkg.lme.plot2, rel_widths = c(2, 1))


### Fat intake (% of total energy) ----
shapiro.test(konjac$TFATperc_t1)
fligner.test(konjac$TFATperc_t1 ~ konjac$treatment)
mt1 <- lm(TFATperc_t1 ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

shapiro.test(konjac$TFATperc_t2)
fligner.test(konjac$TFATperc_t2 ~ konjac$treatment)
mt2 <- lm(TFATperc_t2 ~ treatment, data = konjac)
plot(fitted(mt2), resid(mt2))
abline(0,0) 
qqnorm(resid(mt2))
qqline(resid(mt2))

shapiro.test(konjac$TFATperc_t3)
fligner.test(konjac$TFATperc_t3 ~ konjac$treatment)
mt3 <- lm(TFATperc_t3 ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

shapiro.test(konjac$TFATperc_deltat2)
fligner.test(konjac$TFATperc_deltat2 ~ konjac$treatment)
mtd2 <- lm(TFATperc_deltat2 ~ treatment, data = konjac)
plot(fitted(mtd2), resid(mtd2))
abline(0,0) 
qqnorm(resid(mtd2))
qqline(resid(mtd2))

shapiro.test(konjac$TFATperc_deltat3)
fligner.test(konjac$TFATperc_deltat3 ~ konjac$treatment)
mtd3 <- lm(TFATperc_deltat3 ~ treatment, data = konjac)
plot(fitted(mtd3), resid(mtd3))
abline(0,0) 
qqnorm(resid(mtd3))
qqline(resid(mtd3))

# Mixed-effect model
TFATperc.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$TFATperc_t1, t2 = konjac$TFATperc_t2, t3 = konjac$TFATperc_t3)
TFATperc.df <- TFATperc.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "TFATperc")
TFATperc.df <- na.omit(TFATperc.df)

TFATperc.lme <- lme(TFATperc~treatment*time, random=~1|pair_match/id, data=TFATperc.df, method='REML')
summary(TFATperc.lme)
#random.effects(TFATperc.lme)
TFATperc.lsm <- emmeans(TFATperc.lme,  ~treatment*time)
TFATperc.lsm

TFATperc.lme.plot1 <- ggplot(data = as.data.frame(TFATperc.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Total fat intake (% of energy)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1", "t2", "t3"),labels=c("Week 3", "Week 6", "Week 9"))

TFATperc.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$TFATperc_deltat3)
TFATperc.df <- na.omit(TFATperc.df)

TFATperc.lme <- lme(delta~treatment, random=~1|pair_match/id, data=TFATperc.df, method='REML')
summary(TFATperc.lme)
#random.effects(TFATperc.lme)
TFATperc.lsm <- emmeans(TFATperc.lme,  ~treatment)
TFATperc.lsm

TFATperc.lme.plot2 <- ggplot(data = as.data.frame(TFATperc.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change total fat intake (% of energy)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(TFATperc.lme.plot1, TFATperc.lme.plot2, rel_widths = c(2, 1))


### Fiber intake (g/day) ----
shapiro.test(log(konjac$FIBE_t1))
fligner.test(log(konjac$FIBE_t1) ~ konjac$treatment)
mt1 <- lm(log(FIBE_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

shapiro.test(log(konjac$FIBE_t2))
fligner.test(log(konjac$FIBE_t2) ~ konjac$treatment)
mt2 <- lm(log(FIBE_t2) ~ treatment, data = konjac)
plot(fitted(mt2), resid(mt2))
abline(0,0) 
qqnorm(resid(mt2))
qqline(resid(mt2))

shapiro.test(log(konjac$FIBE_t3))
fligner.test(log(konjac$FIBE_t3) ~ konjac$treatment)
mt3 <- lm(log(FIBE_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

shapiro.test(konjac$FIBE_deltat2)
fligner.test(konjac$FIBE_deltat2 ~ konjac$treatment)
mtd2 <- lm(FIBE_deltat2 ~ treatment, data = konjac)
plot(fitted(mtd2), resid(mtd2))
abline(0,0) 
qqnorm(resid(mtd2))
qqline(resid(mtd2))

shapiro.test(konjac$FIBE_deltat3)
fligner.test(konjac$FIBE_deltat3 ~ konjac$treatment)
mtd3 <- lm(FIBE_deltat3 ~ treatment, data = konjac)
plot(fitted(mtd3), resid(mtd3))
abline(0,0) 
qqnorm(resid(mtd3))
qqline(resid(mtd3))

# Mixed-effect model
FIBE.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$FIBE_t1, t2 = konjac$FIBE_t2, t3 = konjac$FIBE_t3)
FIBE.df <- FIBE.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "FIBE")
FIBE.df <- na.omit(FIBE.df)

FIBE.lme <- lme(log(FIBE)~treatment*time, random=~1|pair_match/id, data=FIBE.df, method='REML')
summary(FIBE.lme)
#random.effects(FIBE.lme)
FIBE.lsm <- emmeans(FIBE.lme, ~treatment*time, type="response")
FIBE.lsm

FIBE.lme.plot1 <- ggplot(data = as.data.frame(FIBE.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Fiber intake (g/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1", "t2", "t3"),labels=c("Week 3", "Week 6", "Week 9"))

FIBE.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$FIBE_deltat3)
FIBE.df <- na.omit(FIBE.df)

FIBE.lme <- lme(delta~treatment, random=~1|pair_match/id, data=FIBE.df, method='REML')
summary(FIBE.lme)
#random.effects(FIBE.lme)
FIBE.lsm <- emmeans(FIBE.lme,  ~treatment)
FIBE.lsm

FIBE.lme.plot2 <- ggplot(data = as.data.frame(FIBE.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change fiber intake (g/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(FIBE.lme.plot1, FIBE.lme.plot2, rel_widths = c(2, 1))


### Normalized fiber intake (g/kg/day) ----
shapiro.test(log(konjac$FIBEperkg_t1))
fligner.test(log(konjac$FIBEperkg_t1) ~ konjac$treatment)
mt1 <- lm(log(FIBEperkg_t1) ~ treatment, data = konjac)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

shapiro.test(log(konjac$FIBEperkg_t2))
fligner.test(log(konjac$FIBEperkg_t2) ~ konjac$treatment)
mt2 <- lm(log(FIBEperkg_t2) ~ treatment, data = konjac)
plot(fitted(mt2), resid(mt2))
abline(0,0) 
qqnorm(resid(mt2))
qqline(resid(mt2))

shapiro.test(log(konjac$FIBEperkg_t3))
fligner.test(log(konjac$FIBEperkg_t3) ~ konjac$treatment)
mt3 <- lm(log(FIBEperkg_t3) ~ treatment, data = konjac)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

shapiro.test(konjac$FIBEperkg_deltat2)
fligner.test(konjac$FIBEperkg_deltat2 ~ konjac$treatment)
mtd2 <- lm(FIBEperkg_deltat2 ~ treatment, data = konjac)
plot(fitted(mtd2), resid(mtd2))
abline(0,0) 
qqnorm(resid(mtd2))
qqline(resid(mtd2))

shapiro.test(konjac$FIBEperkg_deltat3)
fligner.test(konjac$FIBEperkg_deltat3 ~ konjac$treatment)
mtd3 <- lm(FIBEperkg_deltat3 ~ treatment, data = konjac)
plot(fitted(mtd3), resid(mtd3))
abline(0,0) 
qqnorm(resid(mtd3))
qqline(resid(mtd3))

# Mixed-effect model
FIBEperkg.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, t1 = konjac$FIBEperkg_t1, t2 = konjac$FIBEperkg_t2, t3 = konjac$FIBEperkg_t3)
FIBEperkg.df <- FIBEperkg.df %>%
  pivot_longer(cols = c(-id, -pair_match, -treatment), names_to = "time", values_to = "FIBEperkg")
FIBEperkg.df <- na.omit(FIBEperkg.df)

FIBEperkg.lme <- lme(log(FIBEperkg)~treatment*time, random=~1|pair_match/id, data=FIBEperkg.df, method='REML')
summary(FIBEperkg.lme)
#random.effects(FIBEperkg.lme)
FIBEperkg.lsm <- emmeans(FIBEperkg.lme, ~treatment*time, type="response")
FIBEperkg.lsm

FIBEperkg.lme.plot1 <- ggplot(data = as.data.frame(FIBEperkg.lsm), aes(x = time, y = response)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Normalized fiber\nintake (g/kg/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1", "t2", "t3"),labels=c("Week 3", "Week 6", "Week 9"))

FIBEperkg.df <- data.frame(id = konjac$id, pair_match = konjac$pair_match, treatment = konjac$treatment, delta = konjac$FIBEperkg_deltat3)
FIBEperkg.df <- na.omit(FIBEperkg.df)

FIBEperkg.lme <- lme(delta~treatment, random=~1|pair_match/id, data=FIBEperkg.df, method='REML')
summary(FIBEperkg.lme)
#random.effects(FIBEperkg.lme)
FIBEperkg.lsm <- emmeans(FIBEperkg.lme,  ~treatment)
FIBEperkg.lsm

FIBEperkg.lme.plot2 <- ggplot(data = as.data.frame(FIBEperkg.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change normalized fiber\nintake (g/kg/day)") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(FIBEperkg.lme.plot1, FIBEperkg.lme.plot2, rel_widths = c(2, 1))

```

# Gut microbiota
```{r Gut microbiota}
# Load data ----
# Metadata
konjac_meta <- read.delim("konjac.metadata")
rownames(konjac_meta) <- konjac_meta$id

# OTU table
otu_mat<-import_mothur(mothur_shared_file=file.path("konjac.trim.contigs.good.unique.good.filter.unique.precluster.denovo.vsearch.pick.opti_mcc.shared"))

# Taxonomy table
tax_mat = read.table("konjac.trim.contigs.good.unique.good.filter.unique.precluster.denovo.vsearch.pick.opti_mcc.0.03.rep.unaligned.gtdb_taxonomy.tsv", sep = "\t", header = T)
# convert to matrix
taxmat = as.matrix(tax_mat[,-1]) #Remove ID
rownames(taxmat) <- tax_mat$ID
taxmat = tax_table(taxmat)

# reference clustering
taxmat <- taxmat[rownames(taxmat) %in% rownames(otu_mat),]

# Create the phyloseq object
konjac_ps <- phyloseq(otu_table(otu_mat, taxa_are_rows=TRUE), tax_table(taxmat), sample_data(konjac_meta))


# Remove potential contaminants ----
df <- as.data.frame(sample_data(konjac_ps))
df$LibrarySize <- sample_sums(konjac_ps)
df <- df[order(df$LibrarySize),]
df$Index <- seq(nrow(df))
ggplot(data=df, aes(x=Index, y=LibrarySize, color=sample_type)) + geom_point()

# Remove contaminants: DNA concentration obtained with a Qubit-like device
contamdf.freq <- isContaminant(konjac_ps, method="frequency", conc="dna_conc")
head(contamdf.freq)
table(contamdf.freq$contaminant)
which(contamdf.freq$contaminant)

# Remove contaminant taxa and negative controls
konjac.noncontam <- prune_samples(sample_data(konjac_ps)$sample_type!="control_neg", konjac_ps)
konjac.noncontam <- prune_taxa(!contamdf.freq$contaminant, konjac.noncontam)
konjac.noncontam

# Samples with enough depth
sort(colSums(otu_table(konjac.noncontam)))
summary(colSums(otu_table(konjac.noncontam)))
length(which(colSums(otu_table(konjac.noncontam))>10000))

Samples_to_Remove <- c("Mock")
konjac.noncontam <- subset_samples(konjac.noncontam, !(sample %in% Samples_to_Remove))

# Sensitivity analyses ----
#Highly_adherent <- konjac %>%
#  plotly::filter(adh_sachets>0.80) %>%
#  plotly::filter(adherence=="yes") %>%
#  plotly::select(id)

#konjac.noncontam <- subset_samples(konjac.noncontam, (sample %in% Highly_adherent$id))


# Rarefy the OTU table ----
konjac.rare<-rarefy_even_depth(konjac.noncontam, sample.size=10000, replace=FALSE)

# Remove taxa that are only zero
konjac.rare <- phyloseq::prune_taxa(phyloseq::taxa_sums(konjac.rare) > 0, konjac.rare)


# Agglomerate OTUs at different taxonomic levels and CLR transform ----
# GTDB v220 taxonomy
konjac.phylum <- tax_glom(konjac.rare, taxrank = 'Phylum')
konjac.class <- tax_glom(konjac.rare, taxrank = 'Class')
konjac.order <- tax_glom(konjac.rare, taxrank = 'Order')
konjac.family <- tax_glom(konjac.rare, taxrank = 'Family')
konjac.genus <- tax_glom(konjac.rare, taxrank = 'Genus')
konjac.species <- tax_glom(konjac.rare, taxrank = 'Species')


# Alpha diversity ----
# Calculate diversity indexes
konjac_richness = diversityresult(x = t(otu_table(konjac.rare)), index = "richness", method = "each site")
konjac_shannon = diversityresult(x = t(otu_table(konjac.rare)), index = "Shannon", method = "each site")
konjac_evenness = diversityresult(x = t(otu_table(konjac.rare)), index = "Jevenness", method = "each site")

# Prepare the dataset
konjac_alphadiv <- cbind(konjac_richness, konjac_shannon, konjac_evenness, id = sample_data(konjac.rare)$sample, time = sample_data(konjac.rare)$time, sex = sample_data(konjac.rare)$sex, treatment = sample_data(konjac.rare)$treatment, pair_match = sample_data(konjac.rare)$pair_match)

# Split the dataset and calculate deltas
konjac_alphadiv_FI418 <- konjac_alphadiv[konjac_alphadiv$treatment == "FI418",]
konjac_alphadiv_FI236 <- konjac_alphadiv[konjac_alphadiv$treatment == "FI236",]
konjac_alphadiv_t1 <- konjac_alphadiv[konjac_alphadiv$time == "t1",]
konjac_alphadiv_t3 <- konjac_alphadiv[konjac_alphadiv$time == "t3",]

# Convert the data from long to wide format and calculate deltas
konjac_alphadiv_wide <- konjac_alphadiv %>%
  pivot_wider(names_from = time, values_from = c(richness, Shannon, Jevenness))

konjac_alphadiv_wide$richness_delta <- konjac_alphadiv_wide$richness_t3 - konjac_alphadiv_wide$richness_t1

konjac_alphadiv_wide$Shannon_delta <- konjac_alphadiv_wide$Shannon_t3 - konjac_alphadiv_wide$Shannon_t1

konjac_alphadiv_wide$Jevenness_delta <- konjac_alphadiv_wide$Jevenness_t3 - konjac_alphadiv_wide$Jevenness_t1


### Table 1 ----
table1(~ richness_t1 + richness_t3 + richness_delta + Shannon_t1 + Shannon_t3 + Shannon_delta + Jevenness_t1 + Jevenness_t3 + Jevenness_delta | treatment, data = konjac_alphadiv_wide, overall=FALSE, render.continuous=my.render.cont)


### Mixed-effects models (LME) ----

# Richness
shapiro.test(konjac_alphadiv_wide$richness_t1)
fligner.test(konjac_alphadiv_wide$richness_t1 ~ konjac_alphadiv_wide$treatment)
mt1 <- lm(richness_t1 ~ treatment, data = konjac_alphadiv_wide)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

shapiro.test(konjac_alphadiv_wide$richness_t3)
fligner.test(konjac_alphadiv_wide$richness_t3 ~ konjac_alphadiv_wide$treatment)
mt3 <- lm(richness_t3 ~ treatment, data = konjac_alphadiv_wide)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

shapiro.test(konjac_alphadiv_wide$richness_delta)
fligner.test(konjac_alphadiv_wide$richness_delta ~ konjac_alphadiv_wide$treatment)
mtd <- lm(richness_delta ~ treatment, data = konjac_alphadiv_wide)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect model
richness.df <- data.frame(id = konjac_alphadiv$id, pair_match = konjac_alphadiv$pair_match, treatment = konjac_alphadiv$treatment, time = konjac_alphadiv$time, richness = konjac_alphadiv$richness)
richness.df <- na.omit(richness.df)

richness.lme <- lme(richness~treatment*time, random=~1|pair_match/id, data=richness.df, method='REML')
summary(richness.lme)
#random.effects(richness.lme)
richness.lsm <- emmeans(richness.lme,  ~treatment*time)
richness.lsm

richness.lme.plot1 <- ggplot(data = as.data.frame(richness.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "OTU richness") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

richness.df <- data.frame(id = konjac_alphadiv_wide$id, pair_match = konjac_alphadiv_wide$pair_match, treatment = konjac_alphadiv_wide$treatment, delta = konjac_alphadiv_wide$richness_delta)
richness.df <- na.omit(richness.df)

richness.lme <- lme(delta~treatment, random=~1|pair_match/id, data=richness.df, method='REML')
summary(richness.lme)
#random.effects(richness.lme)
richness.lsm <- emmeans(richness.lme,  ~treatment)
richness.lsm

richness.lme.plot2 <- ggplot(data = as.data.frame(richness.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change OTU richness") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(richness.lme.plot1, richness.lme.plot2, rel_widths = c(2, 1))


# Shannon
shapiro.test(konjac_alphadiv_wide$Shannon_t1)
fligner.test(konjac_alphadiv_wide$Shannon_t1 ~ konjac_alphadiv_wide$treatment)
mt1 <- lm(Shannon_t1 ~ treatment, data = konjac_alphadiv_wide)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

shapiro.test(konjac_alphadiv_wide$Shannon_t3)
fligner.test(konjac_alphadiv_wide$Shannon_t3 ~ konjac_alphadiv_wide$treatment)
mt3 <- lm(Shannon_t3 ~ treatment, data = konjac_alphadiv_wide)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

shapiro.test(konjac_alphadiv_wide$Shannon_delta)
fligner.test(konjac_alphadiv_wide$Shannon_delta ~ konjac_alphadiv_wide$treatment)
mtd <- lm(Shannon_delta ~ treatment, data = konjac_alphadiv_wide)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect model
Shannon.df <- data.frame(id = konjac_alphadiv$id, pair_match = konjac_alphadiv$pair_match, treatment = konjac_alphadiv$treatment, time = konjac_alphadiv$time, Shannon = konjac_alphadiv$Shannon)
Shannon.df <- na.omit(Shannon.df)

Shannon.lme <- lme(Shannon~treatment*time, random=~1|pair_match/id, data=Shannon.df, method='REML')
summary(Shannon.lme)
#random.effects(Shannon.lme)
Shannon.lsm <- emmeans(Shannon.lme,  ~treatment*time)
Shannon.lsm

Shannon.lme.plot1 <- ggplot(data = as.data.frame(Shannon.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Shannon index") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

Shannon.df <- data.frame(id = konjac_alphadiv_wide$id, pair_match = konjac_alphadiv_wide$pair_match, treatment = konjac_alphadiv_wide$treatment, delta = konjac_alphadiv_wide$Shannon_delta)
Shannon.df <- na.omit(Shannon.df)

Shannon.lme <- lme(delta~treatment, random=~1|pair_match/id, data=Shannon.df, method='REML')
summary(Shannon.lme)
#random.effects(Shannon.lme)
Shannon.lsm <- emmeans(Shannon.lme,  ~treatment)
Shannon.lsm

Shannon.lme.plot2 <- ggplot(data = as.data.frame(Shannon.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change Shannon index") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(Shannon.lme.plot1, Shannon.lme.plot2, rel_widths = c(2, 1))


# Jevenness (Pielou's Index)
shapiro.test(konjac_alphadiv_wide$Jevenness_t1)
fligner.test(konjac_alphadiv_wide$Jevenness_t1 ~ konjac_alphadiv_wide$treatment)
mt1 <- lm(Jevenness_t1 ~ treatment, data = konjac_alphadiv_wide)
plot(fitted(mt1), resid(mt1))
abline(0,0) 
qqnorm(resid(mt1))
qqline(resid(mt1))

shapiro.test(konjac_alphadiv_wide$Jevenness_t3)
fligner.test(konjac_alphadiv_wide$Jevenness_t3 ~ konjac_alphadiv_wide$treatment)
mt3 <- lm(Jevenness_t3 ~ treatment, data = konjac_alphadiv_wide)
plot(fitted(mt3), resid(mt3))
abline(0,0) 
qqnorm(resid(mt3))
qqline(resid(mt3))

shapiro.test(konjac_alphadiv_wide$Jevenness_delta)
fligner.test(konjac_alphadiv_wide$Jevenness_delta ~ konjac_alphadiv_wide$treatment)
mtd <- lm(Jevenness_delta ~ treatment, data = konjac_alphadiv_wide)
plot(fitted(mtd), resid(mtd))
abline(0,0) 
qqnorm(resid(mtd))
qqline(resid(mtd))

# Mixed-effect model
Jevenness.df <- data.frame(id = konjac_alphadiv$id, pair_match = konjac_alphadiv$pair_match, treatment = konjac_alphadiv$treatment, time = konjac_alphadiv$time, Jevenness = konjac_alphadiv$Jevenness)
Jevenness.df <- na.omit(Jevenness.df)

Jevenness.lme <- lme(Jevenness~treatment*time, random=~1|pair_match/id, data=Jevenness.df, method='REML')
summary(Jevenness.lme)
#random.effects(Jevenness.lme)
Jevenness.lsm <- emmeans(Jevenness.lme,  ~treatment*time)
Jevenness.lsm

Jevenness.lme.plot1 <- ggplot(data = as.data.frame(Jevenness.lsm), aes(x = time, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  facet_grid(~treatment, scales = "free", labeller = as_labeller(treatment_names)) +
  labs(x = "", y = "Pielou evenness") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("t1","t3"),labels=c("Baseline", "End"))

Jevenness.df <- data.frame(id = konjac_alphadiv_wide$id, pair_match = konjac_alphadiv_wide$pair_match, treatment = konjac_alphadiv_wide$treatment, delta = konjac_alphadiv_wide$Jevenness_delta)
Jevenness.df <- na.omit(Jevenness.df)

Jevenness.lme <- lme(delta~treatment, random=~1|pair_match/id, data=Jevenness.df, method='REML')
summary(Jevenness.lme)
#random.effects(Jevenness.lme)
Jevenness.lsm <- emmeans(Jevenness.lme,  ~treatment)
Jevenness.lsm

Jevenness.lme.plot2 <- ggplot(data = as.data.frame(Jevenness.lsm), aes(x = treatment, y = emmean)) +
  geom_errorbar(aes(ymin = lower.CL, ymax = upper.CL), width=.1) +
  geom_point() +
  labs(x = "", y = "Change Pielou evenness") +
  theme(legend.position = "none") +
  scale_x_discrete(breaks=c("FI236","FI418"),labels=c("Control", "Konjac"))

plot_grid(Jevenness.lme.plot1, Jevenness.lme.plot2, rel_widths = c(2, 1))


# Beta diversity ----
# Aitchison distances PCA
konjac.ait_plot <- konjac.rare %>%
  tax_transform("clr") %>%
  ord_calc() %>%
  ord_plot(colour = "treatment", shape = "sex", size="time", alpha=0.8, auto_caption = NA) +
  geom_line(aes(group = sample, colour = treatment)) +
  stat_ellipse(aes(linetype = time, colour = treatment), show.legend = FALSE) +
  scale_color_manual(values=c("#0072B2","#D55E00"), name="Treatment", breaks=c("FI236", "FI418"), labels=c("Control", "Konjac")) +
  scale_shape_manual(values=c(16, 15), name="Sex", breaks=c("female", "male"), labels=c("Female", "Male")) +
  scale_size_manual(values=c(2, 4), name="Time", breaks=c("t1", "t3"), labels=c("Baseline", "End"))

konjac.ait_dist <- dist_calc(konjac.rare, dist = "aitchison")

konjac.ait_dist_t1 <- prune_samples(sample_data(konjac.ait_dist)$time=="t1", konjac.ait_dist)
konjac.ait_dist_t3 <- prune_samples(sample_data(konjac.ait_dist)$time=="t3", konjac.ait_dist)
konjac.ait_dist_FI236 <- prune_samples(sample_data(konjac.ait_dist)$treatment=="FI236", konjac.ait_dist)
konjac.ait_dist_FI418 <- prune_samples(sample_data(konjac.ait_dist)$treatment=="FI418", konjac.ait_dist)


### PERMANOVA ----
ait_perm1 <- konjac.ait_dist %>%
  dist_permanova(
    seed = 1234, # for set.seed to ensure reproducibility of random process
    n_processes = 1, n_perms = 9999, # you should use at least 999!
    variables = "sample + time"
  )
perm_get(ait_perm1)

ait_perm2 <- konjac.ait_dist %>%
  dist_permanova(
    seed = 1234, # for set.seed to ensure reproducibility of random process
    n_processes = 1, n_perms = 9999, # you should use at least 999!
    variables = "treatment + time"
  )
perm_get(ait_perm2)

# Separate analysis per time point
ait_perm3 <- konjac.ait_dist_t1 %>%
  dist_permanova(
    seed = 1234, # for set.seed to ensure reproducibility of random process
    n_processes = 1, n_perms = 9999, # you should use at least 999!
    variables = "treatment"
  )
perm_get(ait_perm3)

ait_perm4 <- konjac.ait_dist_t3 %>%
  dist_permanova(
    seed = 1234, # for set.seed to ensure reproducibility of random process
    n_processes = 1, n_perms = 9999, # you should use at least 999!
    variables = "treatment"
  )
perm_get(ait_perm4)

# Separate analysis per treatment
ait_perm5 <- konjac.ait_dist_FI236 %>%
  dist_permanova(
    seed = 1234, # for set.seed to ensure reproducibility of random process
    n_processes = 1, n_perms = 9999, # you should use at least 999!
    variables = "time + sample"
  )
perm_get(ait_perm5)

ait_perm6 <- konjac.ait_dist_FI418 %>%
  dist_permanova(
    seed = 1234, # for set.seed to ensure reproducibility of random process
    n_processes = 1, n_perms = 9999, # you should use at least 999!
    variables = "time + sample"
  )
perm_get(ait_perm6)


# Compute within-subject distance/dissimilarity for paired samples and then test for the difference between groups
aitchison_dist <- dist_calc(konjac.rare, dist = "aitchison") %>% dist_get()
aitchison_df <- melt(as.matrix(aitchison_dist))

aitchison_df <- aitchison_df %>%
  separate(Var1, into = c("sample_1", "time_1"), sep = "t", remove = FALSE) %>%
  separate(Var2, into = c("sample_2", "time_2"), sep = "t", remove = FALSE) %>%
  mutate(time_1 = ifelse(time_1 == "1", "t1", ifelse(time_1 == "2", "t2", time_1)),
         time_2 = ifelse(time_2 == "1", "t1", ifelse(time_2 == "2", "t2", time_2))) %>%
  plotly::filter(sample_1 == sample_2) %>%
  plotly::filter(time_1 == "t1") %>%
  plotly::filter(time_2 == "t2") %>%
  dplyr::select(sample_1, value) %>%
  dplyr::rename("sample" = "sample_1",
                "aitchison_t1t2" = "value")

meta_df <- data.frame(sample_data(konjac.rare)) %>%
  plotly::filter(time == "t1") %>%
  dplyr::select(sample, time, sex, treatment, pair_match)

aitchison_df <- left_join(aitchison_df, meta_df)

shapiro.test(aitchison_df$aitchison_t1t2)
fligner.test(aitchison_t1t2 ~ treatment, data = aitchison_df)
t.test(aitchison_t1t2 ~ treatment, data = aitchison_df)

aitchinson_plot <- ggplot(aitchison_df, aes(x=treatment, y=aitchison_t1t2)) +
  geom_boxplot(aes(fill=treatment, alpha=0.3), fatten = NULL) +
  stat_summary(fun=mean, color="darkred", geom="crossbar") +
  scale_fill_manual(values=c("#0072B2","#D55E00")) +
#  geom_point(aes(color=pair_match, shape=sex), size=3) +
#  scale_shape_manual(values=c(16, 15)) + 
#  scale_color_manual(values=my_palette) +
  theme(legend.position = "none") + 
#  geom_line(aes(group=pair_match, color=pair_match)) +
  labs(x = "", y = "Aitchison distances\nbetween baseline and\nend of the study") +
  scale_x_discrete(breaks=c("FI236","FI418"),
                   labels=c("Control", "Konjac"))

aitchinson.test <- aitchison_df %>%
  t_test(aitchison_t1t2 ~ treatment)
aitchinson.test <- aitchinson.test %>% add_xy_position(x = "treatment")

aitchinson_plot <- aitchinson_plot + stat_pvalue_manual(aitchinson.test, tip.length = 0)


### Lin's concordance correlation coefficients (CCC): OTU abundance

# Get lower triangle of the correlation matrix
get_lower_tri = function(x){
  x[upper.tri(x, diag=TRUE)] = NA
  return(x)
}

# Aitchison distances
aitchison_dist <- as.matrix(aitchison_dist)
aitchison_dist_low_tri <- get_lower_tri(aitchison_dist)
melted_aitchison_dist = melt(aitchison_dist_low_tri, na.rm = TRUE)
id1 <- str_extract(melted_aitchison_dist$Var1, "KG[0-9]+")
id2 <- str_extract(melted_aitchison_dist$Var2, "KG[0-9]+")
comparison <- function(x, y) ifelse(x == y, "intra", "inter")
id3 = comparison(id1, id2)

aitchison_dist.df <- data.frame(ait = melted_aitchison_dist$value, Var1 = melted_aitchison_dist$Var1, Var2 = melted_aitchison_dist$Var2, id1 = id1, id2 = id2, id3 = id3)
aggregate(ait ~ id3, FUN = mean, data = aitchison_dist.df)

# Correlations after removing  the diagonal of the correlation matrix
intra_inter.aitchison <- ggplot(aitchison_dist.df, aes(x=id3, y=ait)) +
  theme(panel.border = element_blank(), panel.background = element_blank(), legend.position="none") +
  labs(x = "", y = "Aitchison distances\nbetween pairs of samples") +
  geom_jitter(width=0.2, color="gray", size=1) +
  geom_boxplot(outlier.shape=NA, alpha = 0, fatten = NULL) +
  stat_summary(fun=mean, color="darkred", geom="crossbar") +
  scale_x_discrete(breaks=c("inter","intra"),
                   labels=c("Between\nsubjects", "Same\nsubject"))

intra_inter.aitchison.test <- aitchison_dist.df %>%
  t_test(ait ~ id3)
intra_inter.aitchison.test <- intra_inter.aitchison.test %>% add_xy_position(x = "id3")

intra_inter.aitchison <- intra_inter.aitchison + stat_pvalue_manual(intra_inter.aitchison.test, tip.length = 0)

# Figure ----
top_row <- plot_grid(konjac.ait_plot, align = "h", axis = "l", ncol = 1, labels="A")
bottom_row <- plot_grid(intra_inter.aitchison, aitchinson_plot, align = "h", axis = "l", ncol = 2, labels=c("B","C"))
plot_grid(top_row, bottom_row, ncol = 1)


# Differential abundance (ALDEx2) ----

### Phylum ----
# all treatments
konjac.phylum.aldex <- aldex.clr(otu_table(konjac.phylum), sample_data(konjac.phylum)$treatment, mc.samples=1000, denom="all", verbose=F)
konjac.phylum.tt <- aldex.ttest(konjac.phylum.aldex, paired.test=TRUE, verbose=FALSE)
konjac.phylum.effect <- aldex.effect(konjac.phylum.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.phylum.all <- data.frame(tax_table(konjac.phylum),konjac.phylum.tt,konjac.phylum.effect)
konjac.phylum.sig <- konjac.phylum.all[which(konjac.phylum.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.phylum.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.phylum.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.phylum.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# FI236
konjac.phylum.FI236 <- prune_samples(sample_data(konjac.phylum)$treatment=="FI236", konjac.phylum)
konjac.phylum.FI236.aldex <- aldex.clr(otu_table(konjac.phylum.FI236), sample_data(konjac.phylum.FI236)$time, mc.samples=1000, denom="all", verbose=F)
konjac.phylum.FI236.tt <- aldex.ttest(konjac.phylum.FI236.aldex, paired.test=TRUE, verbose=FALSE)
konjac.phylum.FI236.effect <- aldex.effect(konjac.phylum.FI236.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.phylum.FI236.all <- data.frame(tax_table(prune_taxa(rownames(konjac.phylum.FI236.tt), konjac.phylum.FI236)),konjac.phylum.FI236.tt,konjac.phylum.FI236.effect)
konjac.phylum.FI236.sig <- konjac.phylum.FI236.all[which(konjac.phylum.FI236.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.phylum.FI236.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.phylum.FI236.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.phylum.FI236.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# FI418
konjac.phylum.FI418 <- prune_samples(sample_data(konjac.phylum)$treatment=="FI418", konjac.phylum)
konjac.phylum.FI418.aldex <- aldex.clr(otu_table(konjac.phylum.FI418), sample_data(konjac.phylum.FI418)$time, mc.samples=1000, denom="all", verbose=F)
konjac.phylum.FI418.tt <- aldex.ttest(konjac.phylum.FI418.aldex, paired.test=TRUE, verbose=FALSE)
konjac.phylum.FI418.effect <- aldex.effect(konjac.phylum.FI418.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.phylum.FI418.all <- data.frame(tax_table(prune_taxa(rownames(konjac.phylum.FI418.tt), konjac.phylum.FI418)),konjac.phylum.FI418.tt,konjac.phylum.FI418.effect)
konjac.phylum.FI418.sig <- konjac.phylum.FI418.all[which(konjac.phylum.FI418.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.phylum.FI418.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.phylum.FI418.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.phylum.FI418.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# t1
konjac.phylum.t1 <- prune_samples(sample_data(konjac.phylum)$time=="t1", konjac.phylum)
konjac.phylum.t1.aldex <- aldex.clr(otu_table(konjac.phylum.t1), sample_data(konjac.phylum.t1)$treatment, mc.samples=1000, denom="all", verbose=F)
konjac.phylum.t1.tt <- aldex.ttest(konjac.phylum.t1.aldex, paired.test=TRUE, verbose=FALSE)
konjac.phylum.t1.effect <- aldex.effect(konjac.phylum.t1.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.phylum.t1.all <- data.frame(tax_table(prune_taxa(rownames(konjac.phylum.t1.tt), konjac.phylum.t1)),konjac.phylum.t1.tt,konjac.phylum.t1.effect)
konjac.phylum.t1.sig <- konjac.phylum.t1.all[which(konjac.phylum.t1.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.phylum.t1.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.phylum.t1.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.phylum.t1.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# t3
konjac.phylum.t3 <- prune_samples(sample_data(konjac.phylum)$time=="t3", konjac.phylum)
konjac.phylum.t3.aldex <- aldex.clr(otu_table(konjac.phylum.t3), sample_data(konjac.phylum.t3)$treatment, mc.samples=1000, denom="all", verbose=F)
konjac.phylum.t3.tt <- aldex.ttest(konjac.phylum.t3.aldex, paired.test=TRUE, verbose=FALSE)
konjac.phylum.t3.effect <- aldex.effect(konjac.phylum.t3.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.phylum.t3.all <- data.frame(tax_table(prune_taxa(rownames(konjac.phylum.t3.tt), konjac.phylum.t3)),konjac.phylum.t3.tt,konjac.phylum.t3.effect)
konjac.phylum.t3.sig <- konjac.phylum.t3.all[which(konjac.phylum.t3.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.phylum.t3.all, type="MA", test="welch", xlab="Log-ratio abundance",
           ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.phylum.t3.all, type="MW", test="welch", xlab="Dispersion",
    ylab="Difference", main='Effect plot')
aldex.plot(konjac.phylum.t3.all, type="volcano", test="welch", xlab="Difference",
    ylab="-1(log10(q))", main='Volcano plot')


### Family ----
# all treatments
konjac.family.aldex <- aldex.clr(otu_table(konjac.family), sample_data(konjac.family)$treatment, mc.samples=1000, denom="all", verbose=F)
konjac.family.tt <- aldex.ttest(konjac.family.aldex, paired.test=TRUE, verbose=FALSE)
konjac.family.effect <- aldex.effect(konjac.family.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.family.all <- data.frame(tax_table(konjac.family),konjac.family.tt,konjac.family.effect)
konjac.family.sig <- konjac.family.all[which(konjac.family.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.family.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.family.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.family.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# FI236
konjac.family.FI236 <- prune_samples(sample_data(konjac.family)$treatment=="FI236", konjac.family)
konjac.family.FI236.aldex <- aldex.clr(otu_table(konjac.family.FI236), sample_data(konjac.family.FI236)$time, mc.samples=1000, denom="all", verbose=F)
konjac.family.FI236.tt <- aldex.ttest(konjac.family.FI236.aldex, paired.test=TRUE, verbose=FALSE)
konjac.family.FI236.effect <- aldex.effect(konjac.family.FI236.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.family.FI236.all <- data.frame(tax_table(prune_taxa(rownames(konjac.family.FI236.tt), konjac.family.FI236)),konjac.family.FI236.tt,konjac.family.FI236.effect)
konjac.family.FI236.sig <- konjac.family.FI236.all[which(konjac.family.FI236.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.family.FI236.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.family.FI236.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.family.FI236.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# FI418
konjac.family.FI418 <- prune_samples(sample_data(konjac.family)$treatment=="FI418", konjac.family)
konjac.family.FI418.aldex <- aldex.clr(otu_table(konjac.family.FI418), sample_data(konjac.family.FI418)$time, mc.samples=1000, denom="all", verbose=F)
konjac.family.FI418.tt <- aldex.ttest(konjac.family.FI418.aldex, paired.test=TRUE, verbose=FALSE)
konjac.family.FI418.effect <- aldex.effect(konjac.family.FI418.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.family.FI418.all <- data.frame(tax_table(prune_taxa(rownames(konjac.family.FI418.tt), konjac.family.FI418)),konjac.family.FI418.tt,konjac.family.FI418.effect)
konjac.family.FI418.sig <- konjac.family.FI418.all[which(konjac.family.FI418.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.family.FI418.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.family.FI418.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.family.FI418.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# t1
konjac.family.t1 <- prune_samples(sample_data(konjac.family)$time=="t1", konjac.family)
konjac.family.t1.aldex <- aldex.clr(otu_table(konjac.family.t1), sample_data(konjac.family.t1)$treatment, mc.samples=1000, denom="all", verbose=F)
konjac.family.t1.tt <- aldex.ttest(konjac.family.t1.aldex, paired.test=TRUE, verbose=FALSE)
konjac.family.t1.effect <- aldex.effect(konjac.family.t1.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.family.t1.all <- data.frame(tax_table(prune_taxa(rownames(konjac.family.t1.tt), konjac.family.t1)),konjac.family.t1.tt,konjac.family.t1.effect)
konjac.family.t1.sig <- konjac.family.t1.all[which(konjac.family.t1.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.family.t1.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.family.t1.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.family.t1.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# t3
konjac.family.t3 <- prune_samples(sample_data(konjac.family)$time=="t3", konjac.family)
konjac.family.t3.aldex <- aldex.clr(otu_table(konjac.family.t3), sample_data(konjac.family.t3)$treatment, mc.samples=1000, denom="all", verbose=F)
konjac.family.t3.tt <- aldex.ttest(konjac.family.t3.aldex, paired.test=TRUE, verbose=FALSE)
konjac.family.t3.effect <- aldex.effect(konjac.family.t3.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.family.t3.all <- data.frame(tax_table(prune_taxa(rownames(konjac.family.t3.tt), konjac.family.t3)),konjac.family.t3.tt,konjac.family.t3.effect)
konjac.family.t3.sig <- konjac.family.t3.all[which(konjac.family.t3.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.family.t3.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.family.t3.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.family.t3.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')


### Genus ----
# all treatments
konjac.genus.aldex <- aldex.clr(otu_table(konjac.genus), sample_data(konjac.genus)$treatment, mc.samples=1000, denom="all", verbose=F)
konjac.genus.tt <- aldex.ttest(konjac.genus.aldex, paired.test=TRUE, verbose=FALSE)
konjac.genus.effect <- aldex.effect(konjac.genus.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.genus.all <- data.frame(tax_table(konjac.genus),konjac.genus.tt,konjac.genus.effect)
konjac.genus.sig <- konjac.genus.all[which(konjac.genus.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.genus.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.genus.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.genus.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# FI236
konjac.genus.FI236 <- prune_samples(sample_data(konjac.genus)$treatment=="FI236", konjac.genus)
konjac.genus.FI236.aldex <- aldex.clr(otu_table(konjac.genus.FI236), sample_data(konjac.genus.FI236)$time, mc.samples=1000, denom="all", verbose=F)
konjac.genus.FI236.tt <- aldex.ttest(konjac.genus.FI236.aldex, paired.test=TRUE, verbose=FALSE)
konjac.genus.FI236.effect <- aldex.effect(konjac.genus.FI236.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.genus.FI236.all <- data.frame(tax_table(prune_taxa(rownames(konjac.genus.FI236.tt), konjac.genus.FI236)),konjac.genus.FI236.tt,konjac.genus.FI236.effect)
konjac.genus.FI236.sig <- konjac.genus.FI236.all[which(konjac.genus.FI236.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.genus.FI236.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.genus.FI236.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.genus.FI236.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# FI418
konjac.genus.FI418 <- prune_samples(sample_data(konjac.genus)$treatment=="FI418", konjac.genus)
konjac.genus.FI418.aldex <- aldex.clr(otu_table(konjac.genus.FI418), sample_data(konjac.genus.FI418)$time, mc.samples=1000, denom="all", verbose=F)
konjac.genus.FI418.tt <- aldex.ttest(konjac.genus.FI418.aldex, paired.test=TRUE, verbose=FALSE)
konjac.genus.FI418.effect <- aldex.effect(konjac.genus.FI418.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.genus.FI418.all <- data.frame(tax_table(prune_taxa(rownames(konjac.genus.FI418.tt), konjac.genus.FI418)),konjac.genus.FI418.tt,konjac.genus.FI418.effect)
konjac.genus.FI418.sig <- konjac.genus.FI418.all[which(konjac.genus.FI418.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.genus.FI418.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.genus.FI418.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.genus.FI418.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

konjac.genus.FI418.sig <- konjac.genus.FI418.all[which(konjac.genus.FI418.all$wi.ep<0.1),]
konjac.genus.FI418.sigtaxa <- prune_taxa(rownames(konjac.genus.FI418.sig), konjac.genus.clr)

# t1
konjac.genus.t1 <- prune_samples(sample_data(konjac.genus)$time=="t1", konjac.genus)
konjac.genus.t1.aldex <- aldex.clr(otu_table(konjac.genus.t1), sample_data(konjac.genus.t1)$treatment, mc.samples=1000, denom="all", verbose=F)
konjac.genus.t1.tt <- aldex.ttest(konjac.genus.t1.aldex, paired.test=TRUE, verbose=FALSE)
konjac.genus.t1.effect <- aldex.effect(konjac.genus.t1.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.genus.t1.all <- data.frame(tax_table(prune_taxa(rownames(konjac.genus.t1.tt), konjac.genus.t1)),konjac.genus.t1.tt,konjac.genus.t1.effect)
konjac.genus.t1.sig <- konjac.genus.t1.all[which(konjac.genus.t1.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.genus.t1.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.genus.t1.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.genus.t1.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# t3
konjac.genus.t3 <- prune_samples(sample_data(konjac.genus)$time=="t3", konjac.genus)
konjac.genus.t3.aldex <- aldex.clr(otu_table(konjac.genus.t3), sample_data(konjac.genus.t3)$treatment, mc.samples=1000, denom="all", verbose=F)
konjac.genus.t3.tt <- aldex.ttest(konjac.genus.t3.aldex, paired.test=TRUE, verbose=FALSE)
konjac.genus.t3.effect <- aldex.effect(konjac.genus.t3.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.genus.t3.all <- data.frame(tax_table(prune_taxa(rownames(konjac.genus.t3.tt), konjac.genus.t3)),konjac.genus.t3.tt,konjac.genus.t3.effect)
konjac.genus.t3.sig <- konjac.genus.t3.all[which(konjac.genus.t3.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.genus.t3.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.genus.t3.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.genus.t3.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')


### Species ----
# all treatments
konjac.species.aldex <- aldex.clr(otu_table(konjac.species), sample_data(konjac.species)$treatment, mc.samples=1000, denom="all", verbose=F)
konjac.species.tt <- aldex.ttest(konjac.species.aldex, paired.test=TRUE, verbose=FALSE)
konjac.species.effect <- aldex.effect(konjac.species.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.species.all <- data.frame(tax_table(konjac.species),konjac.species.tt,konjac.species.effect)
konjac.species.sig <- konjac.species.all[which(konjac.species.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.species.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.species.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.species.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# FI236
konjac.species.FI236 <- prune_samples(sample_data(konjac.species)$treatment=="FI236", konjac.species)
konjac.species.FI236.aldex <- aldex.clr(otu_table(konjac.species.FI236), sample_data(konjac.species.FI236)$time, mc.samples=1000, denom="all", verbose=F)
konjac.species.FI236.tt <- aldex.ttest(konjac.species.FI236.aldex, paired.test=TRUE, verbose=FALSE)
konjac.species.FI236.effect <- aldex.effect(konjac.species.FI236.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.species.FI236.all <- data.frame(tax_table(prune_taxa(rownames(konjac.species.FI236.tt), konjac.species.FI236)),konjac.species.FI236.tt,konjac.species.FI236.effect)
konjac.species.FI236.sig <- konjac.species.FI236.all[which(konjac.species.FI236.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.species.FI236.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.species.FI236.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.species.FI236.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# FI418
konjac.species.FI418 <- prune_samples(sample_data(konjac.species)$treatment=="FI418", konjac.species)
konjac.species.FI418.aldex <- aldex.clr(otu_table(konjac.species.FI418), sample_data(konjac.species.FI418)$time, mc.samples=1000, denom="all", verbose=F)
konjac.species.FI418.tt <- aldex.ttest(konjac.species.FI418.aldex, paired.test=TRUE, verbose=FALSE)
konjac.species.FI418.effect <- aldex.effect(konjac.species.FI418.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.species.FI418.all <- data.frame(tax_table(prune_taxa(rownames(konjac.species.FI418.tt), konjac.species.FI418)),konjac.species.FI418.tt,konjac.species.FI418.effect)
konjac.species.FI418.sig <- konjac.species.FI418.all[which(konjac.species.FI418.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.species.FI418.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.species.FI418.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.species.FI418.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# t1
konjac.species.t1 <- prune_samples(sample_data(konjac.species)$time=="t1", konjac.species)
konjac.species.t1.aldex <- aldex.clr(otu_table(konjac.species.t1), sample_data(konjac.species.t1)$treatment, mc.samples=1000, denom="all", verbose=F)
konjac.species.t1.tt <- aldex.ttest(konjac.species.t1.aldex, paired.test=TRUE, verbose=FALSE)
konjac.species.t1.effect <- aldex.effect(konjac.species.t1.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.species.t1.all <- data.frame(tax_table(prune_taxa(rownames(konjac.species.t1.tt), konjac.species.t1)),konjac.species.t1.tt,konjac.species.t1.effect)
konjac.species.t1.sig <- konjac.species.t1.all[which(konjac.species.t1.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.species.t1.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.species.t1.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.species.t1.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# t3
konjac.species.t3 <- prune_samples(sample_data(konjac.species)$time=="t3", konjac.species)
konjac.species.t3.aldex <- aldex.clr(otu_table(konjac.species.t3), sample_data(konjac.species.t3)$treatment, mc.samples=1000, denom="all", verbose=F)
konjac.species.t3.tt <- aldex.ttest(konjac.species.t3.aldex, paired.test=TRUE, verbose=FALSE)
konjac.species.t3.effect <- aldex.effect(konjac.species.t3.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.species.t3.all <- data.frame(tax_table(prune_taxa(rownames(konjac.species.t3.tt), konjac.species.t3)),konjac.species.t3.tt,konjac.species.t3.effect)
konjac.species.t3.sig <- konjac.species.t3.all[which(konjac.species.t3.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.species.t3.all, type="MA", test="welch", xlab="Log-ratio abundance",
           ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.species.t3.all, type="MW", test="welch", xlab="Dispersion",
    ylab="Difference", main='Effect plot')
aldex.plot(konjac.species.t3.all, type="volcano", test="welch", xlab="Difference",
    ylab="-1(log10(q))", main='Volcano plot')


### OTU ----
# all treatments
konjac.rare.aldex <- aldex.clr(otu_table(konjac.rare), sample_data(konjac.rare)$treatment, mc.samples=1000, denom="all", verbose=F)
konjac.rare.tt <- aldex.ttest(konjac.rare.aldex, paired.test=TRUE, verbose=FALSE)
konjac.rare.effect <- aldex.effect(konjac.rare.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.rare.all <- data.frame(tax_table(konjac.rare),konjac.rare.tt,konjac.rare.effect)
konjac.rare.sig <- konjac.rare.all[which(konjac.rare.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.rare.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.rare.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.rare.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# FI236
konjac.rare.FI236 <- prune_samples(sample_data(konjac.rare)$treatment=="FI236", konjac.rare)
konjac.rare.FI236.aldex <- aldex.clr(otu_table(konjac.rare.FI236), sample_data(konjac.rare.FI236)$time, mc.samples=1000, denom="all", verbose=F)
konjac.rare.FI236.tt <- aldex.ttest(konjac.rare.FI236.aldex, paired.test=TRUE, verbose=FALSE)
konjac.rare.FI236.effect <- aldex.effect(konjac.rare.FI236.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.rare.FI236.all <- data.frame(tax_table(prune_taxa(rownames(konjac.rare.FI236.tt), konjac.rare.FI236)),konjac.rare.FI236.tt,konjac.rare.FI236.effect)
konjac.rare.FI236.sig <- konjac.rare.FI236.all[which(konjac.rare.FI236.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.rare.FI236.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.rare.FI236.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.rare.FI236.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# FI418
konjac.rare.FI418 <- prune_samples(sample_data(konjac.rare)$treatment=="FI418", konjac.rare)
konjac.rare.FI418.aldex <- aldex.clr(otu_table(konjac.rare.FI418), sample_data(konjac.rare.FI418)$time, mc.samples=1000, denom="all", verbose=F)
konjac.rare.FI418.tt <- aldex.ttest(konjac.rare.FI418.aldex, paired.test=TRUE, verbose=FALSE)
konjac.rare.FI418.effect <- aldex.effect(konjac.rare.FI418.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.rare.FI418.all <- data.frame(tax_table(prune_taxa(rownames(konjac.rare.FI418.tt), konjac.rare.FI418)),konjac.rare.FI418.tt,konjac.rare.FI418.effect)
konjac.rare.FI418.sig <- konjac.rare.FI418.all[which(konjac.rare.FI418.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.rare.FI418.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.rare.FI418.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.rare.FI418.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# t1
konjac.rare.t1 <- prune_samples(sample_data(konjac.rare)$time=="t1", konjac.rare)
konjac.rare.t1.aldex <- aldex.clr(otu_table(konjac.rare.t1), sample_data(konjac.rare.t1)$treatment, mc.samples=1000, denom="all", verbose=F)
konjac.rare.t1.tt <- aldex.ttest(konjac.rare.t1.aldex, paired.test=TRUE, verbose=FALSE)
konjac.rare.t1.effect <- aldex.effect(konjac.rare.t1.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.rare.t1.all <- data.frame(tax_table(prune_taxa(rownames(konjac.rare.t1.tt), konjac.rare.t1)),konjac.rare.t1.tt,konjac.rare.t1.effect)
konjac.rare.t1.sig <- konjac.rare.t1.all[which(konjac.rare.t1.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.rare.t1.all, type="MA", test="welch", xlab="Log-ratio abundance", ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.rare.t1.all, type="MW", test="welch", xlab="Dispersion", ylab="Difference", main='Effect plot')
aldex.plot(konjac.rare.t1.all, type="volcano", test="welch", xlab="Difference", ylab="-1(log10(q))", main='Volcano plot')

# t3
konjac.rare.t3 <- prune_samples(sample_data(konjac.rare)$time=="t3", konjac.rare)
konjac.rare.t3.aldex <- aldex.clr(otu_table(konjac.rare.t3), sample_data(konjac.rare.t3)$treatment, mc.samples=1000, denom="all", verbose=F)
konjac.rare.t3.tt <- aldex.ttest(konjac.rare.t3.aldex, paired.test=TRUE, verbose=FALSE)
konjac.rare.t3.effect <- aldex.effect(konjac.rare.t3.aldex, CI=T, verbose=FALSE, paired.test=TRUE)
konjac.rare.t3.all <- data.frame(tax_table(prune_taxa(rownames(konjac.rare.t3.tt), konjac.rare.t3)),konjac.rare.t3.tt,konjac.rare.t3.effect)
konjac.rare.t3.sig <- konjac.rare.t3.all[which(konjac.rare.t3.all$wi.eBH<0.2),]
par(mfrow=c(1,3))
aldex.plot(konjac.rare.t3.all, type="MA", test="welch", xlab="Log-ratio abundance",
           ylab="Difference", main='Bland-Altman plot')
aldex.plot(konjac.rare.t3.all, type="MW", test="welch", xlab="Dispersion",
    ylab="Difference", main='Effect plot')
aldex.plot(konjac.rare.t3.all, type="volcano", test="welch", xlab="Difference",
    ylab="-1(log10(q))", main='Volcano plot')

```
